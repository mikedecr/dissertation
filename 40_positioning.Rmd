# How District-Party Ideology Affects Primary Candidate Positioning: A Bayesian De-Mediation Model {#ch:positioning}

$\renewcommand{\ind}[0]{\perp \!\!\! \perp}$
$\renewcommand{\doop}[1]{\mathit{do}\left(#1\right)}$
$\renewcommand{\diff}[1]{\, \mathrm{d}#1}$
$\renewcommand{\E}[1]{\mathbb{E}\left[#1\right]}$
$\renewcommand{\p}[1]{p\left(#1\right)}$


<!------- TO DO ---------
- what's the latent relationship between local ideology and primary rules?
- does this explain the weird findings by McGhee et al?
- take credit for CDE interpretation (maybe done?)
- rip Nielson and Visalvanich
------------------------->

```{r stopper, eval = FALSE, cache = FALSE, include = FALSE}
knitr::knit_exit()
```


```{r knitr-04-1-positioning, include = FALSE, cache = FALSE}
source(here::here("assets-bookdown", "knitr-helpers.R"))
```

<!-- might need to add math -->

```{r packages-04-positioning, cache = FALSE}
library("knitr")

library("here")
library("magrittr")
library("tidyverse")

library("estimatr")
library("broom")
library("tidybayes")

library("scales")
library("patchwork")
library("ggdag")
library("latex2exp")
library("ggforce")

theme_dag <- theme_dag(base_family = font_fam)
```


Do primary elections effectively transmit citizens' policy preferences into government? 
For this to be true, we should expect that the policy ideology with a partisan constituency to affect the ideological positioning of candidates who run for that party's nomination. 
This chapter explores the effect of district-party public ideology on the positioning of primary candidates running in that district.

It is important to distinguish the influence of the district-party public from the influence of the district overall.
Does a candidate like Senator Susan Collins have a reputation as a moderate Republican because of a close balance between the number of Republican and Democratic voters in Maine? 
Or is the Republican constituency in Maine relatively moderate compared to Republican constituencies in states that elect more conservative Republicans? Although past research has been interested in the threat of primary challenges as a cause of ideological divergence between partisan legislators [for example @boatright:2013:getting-primaried; @hill:2015:nominating-institution; @hirano-et-al:2010:primary-polarization; @mcghee-et-al:2014:nomination-systems], many of these studies lacked the capability to observe the preferences within local partisan groups as a concept distinct from aggregate partisanship or aggregate voting in the entire district.
This chapter uses my new measures of district-party ideology to investigate this question in ways that previous research projects could not.

The effect of district-party ideology on candidate positioning is a challenging causal inference problem.
We cannot directly compare the "explanatory power" of district-party ideology and district-level voting by measuring whether one is more strongly correlated with candidate ideal points than the other, nor can we simply control for aggregate voting to recover the "partial effect" of district-party ideology.
This is because aggregate policy ideology and aggregate voting are causally related: if a district contains a voter base with more conservative policy preferences, these policy preferences should influence aggregate voting behavior in the district as well as the positioning of candidates who try to respond to those policy preferences.
Simply controlling for district voting in a regression will likely introduce collider bias by conditioning on a post-treatment variable [@greenland-et-al:1999:dags-epidemiology; @montgomery-et-al:2018:colliders].

This chapter advances this literature's use of moder causal inference methods by estimating the effect of district-party ideology on primary candidate positions using sequential $g$-estimation, a structural modeling approach that measures the direct effect of district-party ideology while fixing the mediating effect of district-level voting.
Substantively, I translate the primary candidate's strategic positioning dilemma into the language of causal graphs, highlighting how aggregate districting voting mediates a relationship between district-party ideology and candidate positioning.
Methodologically, I take the sequential $g$ method as it appears in political science [@acharya-blackwell-sen:2016:direct-effects] and embed it in a Bayesian framework.
The Bayesian framework estimates all components of the structural model simultaneously, quantifying uncertainty in all model parameters in a single posterior distribution.
This includes measurement uncertainty in ideal point estimates from the IRT model in Chapter \@ref(ch:model), which is included as a prior distribution over ideal points.
The key payoff for the Bayesian structure, therefore, is a unified framework for conducting inference about treatment effects by marginalizing over other sources of uncertainty, including imprecise data and design parameters.

I find that primary candidates position themselves to fit district-party policy preferences: Republican candidates run more conservative campaigns in districts where the Republican constituency is more conservative, and Democrats run more progressive campaigns to please more progressive partisan constituencies.
This finding holds even when controlling for aggregate district voting using sequential $g$-estimation.
I also find, unlike other studies of primary representation, that primary candidates' responsiveness to district-party ideology is greater in closed primaries and weaker in open primaries.






## Candidate Positioning and Voters' Policy Preferences

How do constituent preferences affect candidate positioning?
This project explores the implications of what @brady-han-pope:2007:out-of-step call the "strategic positioning dilemma" (SPD), striking a balance between moderate position-taking to appease the general election constituency and ideological positioning taking to appease the partisan primary election constituency.
Existing research contains plenty of studies that support the general theoretical intuition of the SPD theory, although I review some conflicts and ambiguities in detail in Chapter \@ref(ch:arg).
To briefly review, general election candidates are rewarded at the ballot box for taking more moderate campaign stances [@canes-wrone-et-al:2002:out-of-step; @hall:2015:extremists] and aligning themselves with local public opinion on specific issues [@fenno:1978:home-style; @canes-wrone-et-al:2011:issue-accountability; though see @fowler-hall:2016:convergence].
Nevertheless, no candidate makes it to the general election without first winning a primary nomination, where many scholars theorize that candidates benefit by taking more ideological positions that represent conventional views within the party.
This could be a within-party Downsian incentive: the median primary voter is a ideological partisan with off-median policy preferences, so candidates take more extreme positions to appeal to partisan constituency preferences
[@aldrich:1983:downsian-parties; @burden:2001:polarizing-primaries].
This is consistent with evidence from safe congressional districts, where candidates experience less general election threat and can more freely position their campaigns to target the primary electorate [@ansolabehere-et-al:2001:candidate-positioning; @burden:2004:candidate-positioning].
Pressures for primary candidates to take non-median stances may come through mechanisms unrelated to bottom-up voter pressures, instead reflecting candidates' need to organize committed staff and volunteers for their campaigns [@mcclosky-et-al:1960:conventions; @layman-et-al:2010:activists-conflict-extension; @aldrich:2011:why-parties], seek campaign funds from policy-seeking contributors [@laraja-schaffner:2015:campaign-finance-polarization; @barber:2016:contributions-polarization; @barber-et-al:2016:ideological-donors], or garner support from policy-demanding groups that control access to connections and resources to support candidates [@cohen-et-al:2009:party-decides; @koger-et-al:2009-partisan-webs; @masket:2009:no-middle-ground].

As I explained in more detail in Chapter \@ref(ch:arg), the explicit evidence about the SPD from primary elections themselves is surprisingly weak.
This is mainly because most studies do not explicitly measure the ideological preferences of primary voters, instead using aggregate measures of voting that are not able to identify policy preferences [@kernell:2009:districts].
Furthermore, most aggregate-level measures of policy ideology do not differentiate between partisan constituencies in the same district [e.g. @tausanovitch-warshaw:2013:constituent-prefs], which is important for understanding how candidates respond to their specific primary constituency.
Without data that more closely resembles the theoretical story in question, studies that claim to demonstrate that candidates "handle the [strategic positioning] dilemma by positioning themselves closer to the primary electorate" rarely show anything of the sort [@brady-han-pope:2007:out-of-step, p. 79].
@brady-han-pope:2007:out-of-step show that among incumbent members of Congress, more liberal Democrats and more conservative Republicans attract fewer primary challenges and perform better in primary elections, but neither of these findings say anything specific lessons about how candidates are positioned relative to primary constituencies.
@hirano-et-al:2010:primary-polarization get closer to this project's contribution by creating a statewide measure of primary electorate ideology from exit poll questions on ideological self-placement.
They find that incumbent NOMINATE scores are more strongly related to general electorate ideological self-placement than primary electorate self-placement, a similar pattern as shown in Chapter \@ref(ch:arg), Figure \@ref(fig:plot-compare-measures). 
They further find no evidence that incumbent members of Congress do not have more extreme NOMINATE scores under greater threats of primary competition or higher primary turnout.
This finding conflicts partially with @clinton:2006:constituent-representation, who uses a large opinion survey of partisan voters in every congressional district to show that Republican members of Congress have NOMINATE scores that are more strongly related to the median Republican in their district, while Democrats' NOMINATE scores are more strongly related to the overall district median constituent.
The IRT measures of district-party ideology that I create in Chapter \@ref(ch:model) is a more direct measure of policy preferences than ideological self-placement scores or additive issue scores, which respectively tap a large amount of "symbolic" or identity-focused conceptions of political ideology or do not accord for differential measurement error across policy issues [@ellis-stimson:2012:symbolic-ideology; @treier-hillygus:2009:ideology].
My IRT ideal point scores, to my knowledge, are the first ideology scores for district-party groups to be applied to the study of congressional primaries.^[
  For IRT estimates of partisan constituencies and "ideological nationalization" at the U.S. state level, see @caughey-et-al:2018:ideological-nationalization.
]

Research on primary competition and candidate positioning is also held back by the availability of primary candidate data, which until recently was not available. 
Past studies of primary competition and polarization typically use ideology scores from legislative roll call votes, which include only incumbent members of congress or state legislators [@brady-han-pope:2007:out-of-step; @hirano-et-al:2010:primary-polarization; @mcghee-et-al:2014:nomination-systems], or they use surveys of general election candidates, which may include non-incumbent candidates for the general election but no candidates who ran in the primary and lost [@ansolabehere-et-al:2001:candidate-positioning; @burden:2004:candidate-positioning]. 
Recent ideal point methods that use political financial contributions data have the capacity to scale a much broader universe of political actors, including candidates, political parties, PACS and interest groups, and donors [@bonica:2013:ideology-interests; @bonica:2014:mapping-ideology; @hall-snyder:2015:ideology].
Few notable studies have yet used these contribution-based scores to study primary candidates [@thomsen:2014:moderate-candidates; @rogowski-langella:2015:primary-systems; @ahler-citrin-lenz:2016:CA-open-primaries; @porter-treul:2020:primary-experience; @thomsen:2020:ideology-gender].

Even with better measures of district-party ideology and candidate positions, there are some reasons to suspect that district-party ideology does not have a straightforward effect on candidate extremism. 
@thomsen:2014:moderate-candidates finds that politicians are less likely to run for Congress (versus a state office) if their moderate stances make them a weaker "fit" for their party, measured as a greater distance between a candidate's CF score and the average CF score in their state-party.
This process could weaken the relationship between district-party ideology and candidate positioning because moderate candidates select themselves out of the campaign, even if they might appeal to district partisan voters.
@porter-treul:2020:primary-experience find that the number of primary candidates who lack prior elected experience is increasing over time.
Interestingly, they find no pattern between candidate experience and candidate extremism.
This non-relationship may indicate that the positioning of inexperienced candidates may be less related to district-party ideology, either because the candidates are not adept at perceiving local ideology, they do not have the resources to conduct or acquire surveys of their constituencies, or emphasize non-ideological appeals in their campaigns. 
Incumbents, in turn, may be more responsive to local ideology as a result of their political skills and survivorship bias—ill-fitting candidates don't become incumbents in the first place—although incumbents systematically misperceive public opinion as well [@broockman-skovron:2018:bias].


### Primary rules

More recent studies of primary candidates tend not to focus on the overall relationship between voters' policy ideology and candidate positions. 
Instead, there is an enduring interest in the way primary rules affect candidates' positioning incentives by altering the composition of the primary electorate.
Primary "rules" refer to regulations in state election law that control which voters can participate in primary elections and which inclusion criteria parties can define within those legal confines.
A state primary is "closed" if only registered members of a political party are allowed to vote in the party's primary election.
On the other side of the spectrum, an "open" primary allows any registered voter to cast a vote in any party's primary.
There are many more states whose primary rules fall between these two extremes, such as "semi-closed" systems that allow party-unaffiliated voters to choose which party primary they want to vote for, even if registered partisans must vote in the primary of their party registration [@mcghee-et-al:2014:nomination-systems].
Political scientists and political observers speculate that these rules shape candidates' positioning incentives by changing the composition of primary voters.
Closed primary elections, so the argument goes, are limited to registered party identifiers in a district, so candidates running in closed primaries must appeal to a more ideologically homogeneous primary electorate in order to win the nomination.
More open systems, especially "blanket" systems where candidates from all parties run on the same primary ballot to advance to the general election, encourage primary candidates to take more moderate stances to attract a more ideologically diverse primary coalition.
The general hypothesis, therefore, is that more restrictive primary rules exacerbate ideological polarization in congress and in state legislatures, and furthermore that polarization might be combated by moving primary elections to more open rules.

This "primary rules hypothesis" receives essentially zero support across several studies of U.S. elections.
@hill:2015:nominating-institution studies the relationship between primary rules and the ideological makeup of the primary electorate, asking if primary voters in states with more open primary rules are in fact more moderate on average than primary voters under closed primary rules.
Estimating an IRT ideal point model on individual CCES respondents in each congressional district and validated voter turnout data, Hill finds that primary voters are more ideologically consistent than general election voters in the same party, but primary voters are no more extreme in closed primary states than in open primary states.
Even if primary electorates are not affected by state primary rules, candidates may still suspect that primary rules matter and position themselves accordingly.
@rogowski-langella:2015:primary-systems study the relationship between primary rules and candidate positioning as measured with CF scores.
They find no systematic evidence that either congressional candidates or state legislative candidates are more extreme in closed primary states or more moderate in open primary states. 
@mcghee-et-al:2014:nomination-systems also study state legislators but using ideology scores that bridge the NOMINATE ideal point space to state legislative voting [@shor-mccarty:2011:mapping-state-legs], again finding no convincing evidence that primary systems matter for polarization in state legislatures.
Within-state studies of changes to primary rules over time find mixed and highly qualified results, focused primarily on California's change to a "top two" primary system.^[
  In a top-two system, candidates from all parties compete in a single primary for two spots on the general election ballot, which are awarded to the top two plurality winners in the primary.
]
@bullock-clinton:2011:CA-blanket-primary find that the shift to the top-two primary promoted the election of more moderate candidates in California in competitive districts, measured using the two-party presidential vote, but no effects in more lopsided districts.
Looking at the mechanisms underlying this, however, @hill:2015:nominating-institution, who finds no effect on the ideological composition of primary voters after California's reforms, and survey experiments by @ahler-citrin-lenz:2016:CA-open-primaries broadly show that voters are unable to identify which candidates are more ideological and which are more moderate.

I leverage my new data on district-party ideology to revisit the primary rules hypothesis in Section \@ref(sec:g-modification) below.
Unlike most studies, I find that more candidates are less responsive to district-party ideology in states with more open primary rules, consistent with the primary rules hypothesis.


### Ideology within the two major parties

The SPD claims that candidates should be differentially responsive to primary and general electorates, but other theories on the ideological nature of U.S. parties may be relevant as well.
An increasingly prominent theoretical perspective in U.S. political research holds that the parties are not asymmetrical but instead exhibit many "asymmetries" that help explain recent political conflict.
In particular, the Republican Party is understood as an "ideological" party committed to a smaller welfare state, less regulation of business, and conservative cultural values, while the Democratic Party is a "group-based" party whose priorities reflect the mixture of social groups that compose the party's core constituency [@grossman-hopkins:2016:asymmetric-politics]. 
The mixture of group interests within the Democratic Party leads to internal conflicts about which policies to prioritize, while the Republican Party is more concerned with who is a "real Republican" or a "real conservative" [@freeman:1986:party-cultures]. 
The ideological consensus in Republican political thought provides constituents with many different values-based rationales for supporting conservative policies, while Democrats remain more conflicted about how to rationalize their desires for activist government policies against an individualistic American value system that downplays the significance of group identities [@free-cantril:1967:american-beliefs; @feldman-zaller:1992:political-ambivalence; @lelkes-sniderman:2016:ideological-asymmetry]. 

The ideological foundations of U.S. political parties could be relevant for the way candidates conceive of their "responsiveness" to constituents.
Because the Republican Party has an ideological underpinning, and elite political actors will be more aware of partisan ideology than individual constituents will be, Republican candidates may not exhibit much ideological responsiveness even if their constituents' _policy attitudes_ contain real variation.
In other words, the ideological identity of the Republican Party could be a stronger organizing principle for Republican candidate positioning than the heterogeneous views of local constituencies.
Democrats, meanwhile, may appear more responsive to district-party ideology because local opinion variation reflects the social group profile of the constituency, which is the organizing feature of Democratic Party representation.
The intuition of these "asymmetric party" predictions diverge from [@clinton:2006:constituent-representation], who finds that Republicans are _more_ responsive to within-party opinion variation than Democrats but doesn't provide much theoretical exploration of why this should be the case.



### Exploratory analysis

The analysis begins by examining the topline correlation between district-party ideology and candidate positions.
For the dependent variable, I use the dynamic CF score included in the DIME congressional candidate database for 2012, 2014, and 2016 candidates [@bonica:2019:dime]. 
For district-party ideology, I use the mean from the MCMC samples of the IRT model in Chapter \@ref(ch:model), which are estimated from polling data over the 2010s districting cycle.
Using only the mean understates the amount of uncertainty in the ensuing analysis, which is later corrected in the full analysis.
For now, these initial investigations serve only to give us an impression of the raw data.





```{r read-data}
full_data <- read_rds(here("data", "_clean", "candidates-x-irt.rds"))
```

```{r read-eda-fits}
eda_fits <- 
  read_rds(here("data", "_model-output", "04-positioning", "eda-fits.rds"))
```


```{r by-party}
party_sum <- eda_fits %>%
  filter(incumbency == primary_rules_cso) %>%
  filter(incumbency == cycle) %>%
  unnest(lm_tidy) %>%
  filter(term == "theta_mean") %>%
  rename_at(vars(term:outcome), ~ str_glue("b_{.}")) %>%
  unnest(lm_glance) %>%
  mutate(party = names(party_colors)[party_num]) %>%
  print()

party_fit <- party_sum %>%
  unnest(lm_predict) %>%
  print()
```

```{r plot-by-party}
ggplot(full_data) +
  aes(x = theta_mean, y = recipient_cfscore_dyn) +
  geom_point(
    aes(color = as.factor(party_num)), 
    size = 2.75, shape = 16, alpha = 0.25
  ) + 
  geom_ribbon(
    data = party_fit,
    aes(y = NULL, ymin = lwr, ymax = upr, group = as.factor(party_num)),
    alpha = 0.7,
    fill = "gray", 
    color = NA
  ) +
  geom_line(
    data = party_fit, 
    aes(y = fit, group = as.factor(party_num)),
    color = "black"
  ) +
  scale_y_continuous(breaks = seq(-4, 4, 2)) +
  scale_color_manual(values = party_factor_colors) +
  scale_fill_manual(values = party_factor_colors) +
  scale_shape_manual(values = c("1" = "D", "2" = "R")) +
  labs(
    title = "Candidate Positioning and Group Ideology",
    subtitle = "Candidates from 2012, 2014, and 2016",
    x = "District-Party Ideal Point\n(Posterior Mean)", 
    y = "Candidate CF Score"
  ) +
  theme(legend.position = "none") +
  geom_text(
    size = 3.5,
    data = party_sum %>%
      mutate(
        theta_mean = c(-1.75, 0.05),
        recipient_cfscore_dyn = c(3, -3)
      ),
    aes(label = str_glue("{party} (N = {comma(N)})\nr = {round(r, 2)}")),
    hjust = 0
  ) 
```

Figure \@ref(fig:plot-by-party) shows the topline relationship between primary candidate CF scores and the ideal point mean for the district-party they ran to represent.
Each point represents a primary candidate for Congress in either the Democratic or Republican Party primary in years 2012, 2014, and 2016 as they appear in the DIME congressional database.
This totals `r party_sum %>% filter(party == "Democrats") %>% pull(N) %>% comma()` Democratic candidates and `r party_sum %>% filter(party == "Republicans") %>% pull(N) %>% comma()` Republican candidates over three election cycles.
In addition to each candidate, I plot least-squares regression lines calculated separately for each party.
Confidence intervals reflect standard errors that are clustered at the district-party level to capture correlated error among candidates who run in the same primary race.

```{r plot-by-party, include = TRUE, fig.width = 6, fig.height = 5, fig.cap = "Topline relationship between district-party ideology and candidate positions. The horizontal axis plots the posterior mean for a group ideology, and the vertical axis is the dynamic CF score for primary candidates included in the DIME congressional candidate database.", fig.scap = "Topline relationship between district-party ideology and candidate positions."}
```


The figure shows a weak but decisively positive relationship between ideal point means and CF scores; district-parties that are more conservative see more conservative primary candidates.
The relationship is stronger for Democrats than for Republicans in slope (`r filter(party_sum, party_num == 1) %>% pull(b_estimate) %>% round(2)` versus `r filter(party_sum, party_num == 2) %>% pull(b_estimate) %>% round(2)`) and in correlation (`r filter(party_sum, party_num == 1) %>% pull(r) %>% round(2)` versus `r filter(party_sum, party_num == 2) %>% pull(r) %>% round(2)`).
Because one-unit increases are large on the ideal-point scale, it is helpful to standardize these coefficients in terms of standard deviations in the raw data.
Conveniently for a bivariate regression, the standardized coefficient is equivalent to the correlation coefficient.
Increasing district-party ideology by one within-party standard deviation is associated with a CF score increase of `r filter(party_sum, party_num == 1) %>% pull(r) %>% round(2)` standard deviations among Democrats (`r dem_p <- filter(party_sum, party_num == 1) %>% pull(b_p.value) %>% round(2); stopifnot(dem_p < .01)` $p < .01$) and `r filter(party_sum, party_num == 2) %>% pull(r) %>% round(2)` standard deviations among Republicans ($p = `r filter(party_sum, party_num == 2) %>% pull(b_p.value) %>% round(2)`$).
A small number of outlier CF scores exist for each party, but these outliers are few compared to the approximately 2,000 observations in each party.
The regression lines track the center of each party's ideal point distribution, so these outliers do not appear to be large influences on the topline relationship.


```{r by-incumbency, eval = TRUE}
incum_sum <- eda_fits %>%
  filter(primary_rules_cso == cycle) %>%
  filter(incumbency != "All") %>%
  unnest(lm_tidy) %>%
  filter(term == "theta_mean") %>%
  rename_at(vars(term:outcome), ~ str_glue("b_{.}")) %>%
  unnest(lm_glance) %>%
  mutate(
    party = names(party_colors)[party_num],
    p_lab = ifelse(b_p.value < .01, 'p < .01', str_glue("p = {round(b_p.value, 2)}"))
  ) %>%
  arrange(party_num) %>%
  print()

incum_fit <- incum_sum %>%
  unnest(lm_predict) %>%
  print()
```



```{r plot-by-incumbency}
ggplot(full_data) +
  aes(x = theta_mean, y = recipient_cfscore_dyn) +
  facet_wrap(
    ~ fct_relevel(incumbency, "Incumbent"), 
    labeller = as_labeller(function(x) str_glue("{x}s"))
  ) +
  geom_point(
    aes(color = as.factor(party_num)), 
    size = 2.5, shape = 16, alpha = 0.25
  ) + 
  geom_ribbon(
      data = incum_fit,
      aes(y = NULL, ymin = lwr, ymax = upr, group = as.factor(party_num)),
      alpha = 0.7,
      fill = "gray", color = NA
    ) +
    geom_line(
      data = incum_fit, 
      aes(y = fit, group = as.factor(party_num))
    ) +
  scale_y_continuous(breaks = seq(-4, 4, 2)) +
  scale_color_manual(values = party_factor_colors) +
  scale_fill_manual(values = party_factor_colors) +
  labs(
    title = "Incumbency Status and Ideological Responsiveness",
    subtitle = "Candidates from 2012, 2014, and 2016",
    x = "District-Party Ideal Point\n(Posterior Mean)", 
    y = "Candidate CF Score"
  ) +
  theme(legend.position = "none") +
  geom_text(
    size = 3.5,
    data = incum_sum %>% 
      mutate(
        theta_mean = c(rep(-1.75, 3), rep(-0.25, 3)), 
        recipient_cfscore_dyn = c(rep(3, 3), rep(-3, 3)) 
      ), 
      aes(label = str_glue("{party}\nn = {comma(N, accuracy = 1)}\nr = {round(r, 2)}\n{p_lab}")), 
      hjust = 0
   ) 
```

Figure \@ref(fig:plot-by-incumbency) plots the same relationship with candidates divided into incumbents, challengers of incumbents, and candidates running for a district with no incumbent running for reelection.
It is immediately noticeable that CF scores have lower variance among incumbent candidates than among non-incumbent incumbents, and the correlations between CF scores and ideal point means are markedly higher: `r filter(incum_sum, party_num == 1, incumbency == "Incumbent") %>% pull(r) %>% round(2)` among Democrats and `r filter(incum_sum, party_num == 2, incumbency == "Incumbent") %>% pull(r) %>% round(2)`.
The overall higher correlation suggests incumbents could be more capable at positioning themselves for their primary electorates or that prior elections are effective at screening out ill-fitting candidates to represent the district.
The higher correlation among Democrats also disappears among incumbent candidates, suggesting that no party is obviously more responsive to primary constituencies than the other, contrary to @clinton:2006:constituent-representation's finding that Republican incumbents were uniquely sensitive to ideological variation within their partisan bases.
CF scores are higher variance among challengers and open-seat candidates, and their relationship to district-party ideology is weaker but still positive. 
This may be because challengers and open seat candidates must seek other ways to appeal to candidates aside from ideological fit.
This would be consistent with @boatright:2013:getting-primaried's key finding that primary challenges focused purely on ideological fit to the district are relatively rare.
A more mechanical explanation could be that CF scores are higher variance for challengers and open seat candidates because they struggle to raise from the same concentrated network of donors as incumbents do, attenuating the relationship between CF scores and district-party ideologies.
Even still, the data generally suggest that candidates of all statuses have some awareness, on average, of how to position themselves as more conservative or progressive to corner their local partisan constituencies.
Almost all relationships are statistical significant at a $1$% level except among open seat candidates, whose sample sizes are also smaller.

Another notable finding among incumbents is the appearance of a much smaller "intercept shift" between the two parties.
While other studies typically find a large gap between Republicans and Democrats who represent otherwise equivalent districts [@mccarty-poole-rosenthal:2009:gerrymandering; among others], the predicted CF scores for Democratic and Republican incumbents appear to diverge less dramatically if each regression line were extrapolated to meet at moderate values of district-party ideology.
This interpretation comes with several caveats, naturally.
First, there is no way to know if a linear extrapolation is an appropriate method for comparing parties in "otherwise equivalent districts," since there are no districts whose partisan constituencies are similar enough to make that extrapolation without strict functional form assumptions.
Second, a cursory regression analysis of CF scores on district-party ideology and party still finds mean difference between the two parties, even though it is smaller among incumbents.
Nevertheless, the data broadly reinforce the theoretical notion responsiveness to partisan constituencies partially explains at least some of the ideological distance between Republican and Democratic candidates running in the same district.
Future research on inter-party divergence could incorporate district-party ideology scores and address this issue more directly.


```{r plot-by-incumbency, include = TRUE, out.width = "100%", fig.width = 9, fig.height = 4.5, fig.cap = "District-party ideology and candidate positioning across candidate incumbency status.", fig.scap = "District-party ideology and candidate positioning for incumbents, challengers, and open-seat candidates."}
```

```{r by-cycle, eval = TRUE}
cycle_sum <- eda_fits %>%
  filter(primary_rules_cso == incumbency) %>%
  filter(cycle != "All") %>%
  unnest(lm_tidy) %>%
  filter(term == "theta_mean") %>%
  rename_at(vars(term:outcome), ~ str_glue("b_{.}")) %>%
  unnest(lm_glance) %>%
  mutate(
    party = names(party_colors)[party_num],
    p_lab = ifelse(b_p.value < .01, 'p < .01', str_glue("p = {round(b_p.value, 2)}"))
  ) %>%
  arrange(party_num) %>%
  print()

select(cycle_sum, p_lab)

cycle_fit <- cycle_sum %>%
  unnest(lm_predict) %>%
  print()
```

```{r plot-by-cycle}
ggplot(full_data) +
  aes(x = theta_mean, y = recipient_cfscore_dyn) +
  facet_wrap(~ str_glue("{cycle} Campaign")) +
  geom_point(
    aes(color = as.factor(party_num)), 
    size = 2.5, shape = 16, alpha = 0.25
  ) + 
  geom_ribbon(
      data = cycle_fit,
      aes(y = NULL, ymin = lwr, ymax = upr, group = as.factor(party_num)),
      alpha = 0.7,
      fill = "gray", color = NA
    ) +
    geom_line(
      data = cycle_fit, 
      aes(y = fit, group = as.factor(party_num))
    ) +
  scale_y_continuous(breaks = seq(-4, 4, 2)) +
  scale_color_manual(values = party_factor_colors) +
  scale_fill_manual(values = party_factor_colors) +
  labs(
    title = "Ideological Responsiveness Across 2010s Districting Cycle",
    subtitle = "Each year contains incumbents, challengers, and open seats",
    x = "District-Party Ideal Point\n(Posterior Mean)", 
    y = "Candidate CF Score"
  ) +
  theme(legend.position = "none") +
  geom_text(
    size = 3.5,
    data = cycle_sum %>% 
      mutate(
        theta_mean = c(rep(-1.75, 3), rep(-0.25, 3)), 
        recipient_cfscore_dyn = c(rep(3, 3), rep(-3, 3)) 
      ), 
      aes(label = str_glue("{party}\nn = {comma(N, accuracy = 1)}\nr = {round(r, 2)}\n{p_lab}")), 
      hjust = 0
   ) 
```

Figure \@ref(fig:plot-by-cycle) shows how the relationship between district-party ideology and CF scores varies by election year, splitting the 2012, 2014, and 2016 campaign cycles into three panels.
There is no definitive trend toward increasing polarization or increasing responsiveness to partisan ideology in more recent years, which which is inconsistent with theoretical speculation that candidates have become more sensitive to primary electorates over the past few elections.
Instead, the same weak but positive relationship appears in nearly all subsets of data with no overwhelming explanation for differences over time or between parties.
The flattest relationship actually appears most recently for Republicans in 2016, among whom the relationship is nearly flat.
We should hesitate to interpret too much from one estimate, but future researchers could investigate whether financial contributions by Republican donors had a different ideological character in 2016, if perhaps Donald Trump's unusual campaign platform altered which donors wanted to support which candidates, or if moderate donors directed their money away from Republican candidates in anticipation of a Democratic national victory.

<!------- TO DO ---------
- why is this
------------------------->

```{r plot-by-cycle, include = TRUE, out.width = "100%", fig.width = 9, fig.height = 4.5, fig.cap = "District-party ideology and candidate positioning across election cycles within the 2010s districting cycle.", fig.scap = "District-party ideology and candidate positioning in 2012, 2014, and 2016."}
```

```{r by-rules, eval = TRUE}
primary_sum <- eda_fits %>%
  filter(cycle == incumbency) %>%
  filter(primary_rules_cso != "All" & is.na(primary_rules_cso) == FALSE) %>%
  unnest(lm_tidy) %>%
  filter(term == "theta_mean") %>%
  rename_at(vars(term:outcome), ~ str_glue("b_{.}")) %>%
  unnest(lm_glance) %>%
  mutate(
    party = names(party_colors)[party_num],
    p_lab = ifelse(b_p.value < .01, 'p < .01', str_glue("p = {round(b_p.value, 2)}"))
  ) %>%
  arrange(party_num) %>%
  print()

select(primary_sum, p_lab)
select(primary_sum, r)

primary_fit <- primary_sum %>%
  unnest(lm_predict) %>%
  print()
```

```{r plot-by-rules}
full_data %>%
  filter(is.na(primary_rules_cso) == FALSE) %>%
  ggplot() +
  aes(x = theta_mean, y = recipient_cfscore_dyn) +
  facet_wrap(
    ~ fct_relevel(primary_rules_cso, "closed", "semi"),
    labeller = 
      c("closed" = "Closed", "semi" = "Semi-Closed", "open" = "Open") %>%
      as_labeller()
  ) +
  geom_point(
    aes(color = as.factor(party_num)), 
    size = 2.5, shape = 16, alpha = 0.25
  ) + 
  geom_ribbon(
      data = primary_fit,
      aes(y = NULL, ymin = lwr, ymax = upr, group = as.factor(party_num)),
      alpha = 0.7,
      fill = "gray", color = NA
    ) +
    geom_line(
      data = primary_fit, 
      aes(y = fit, group = as.factor(party_num))
    ) +
  scale_y_continuous(breaks = seq(-4, 4, 2)) +
  scale_color_manual(values = party_factor_colors) +
  scale_fill_manual(values = party_factor_colors) +
  labs(
    title = "Ideological Responsiveness Across Primary Rules",
    subtitle = "Collapsed coding of primary rules",
    x = "District-Party Ideal Point\n(Posterior Mean)", 
    y = "Candidate CF Score"
  ) +
  theme(legend.position = "none") +
  geom_text(
    size = 3.5,
    data = primary_sum %>% 
      mutate(
        theta_mean = c(rep(-1.75, 3), rep(-0.25, 3)), 
        recipient_cfscore_dyn = c(rep(3, 3), rep(-3, 3)) 
      ), 
      aes(label = str_glue("{party}\nn = {comma(N, accuracy = 1)}\nr = {round(r, 2)}\n{p_lab}")), 
      hjust = 0
   ) 
```


```{r rules-means}
rule_means <- full_data %>%
  group_by(party) %>%
  nest() %>%
  mutate(
    lm = map(
      data, 
      ~ lm_robust(
        recipient_cfscore_dyn ~ 0 + primary_rules_cso, 
        clusters = group,
        data = .x
      )
    ),
    tidy = map(lm, tidy, conf.int = TRUE)
  ) %>%
  unnest(tidy) %>%
  mutate(
    term_label = case_when(
      str_detect(term, "open") ~ "Open Primary",
      str_detect(term, "semi") ~ "Semi-Closed Primary",
      str_detect(term, "closed") ~ "Closed Primary"
    ) %>%
    fct_relevel("Open Primary", "Semi-Closed Primary")
  ) %>% 
  print()
```

```{r plot-rules-means}
ggplot(rule_means) +
  aes(x = term_label, y = estimate) +
  facet_wrap(
    ~ party, 
    scales = "free_x",
    labeller = as_labeller(c("D" = "Democrats", "R" = "Republicans"))
  ) +
  geom_pointrange(
    aes(ymin = conf.low, ymax = conf.high, color = party),
    position = position_dodge(width = -0.25),
    show.legend = FALSE
  ) +
  scale_color_manual(values = party_code_colors) +
  coord_flip() +
  labs(
    y = "Average CF Score", x = NULL,
    title = "Average CF Scores by Primary Openness",
    subtitle = "Relationship is opposite theoretical expectations"
  )
```

Finally, Figures \@ref(fig:plot-rules-means) and \@ref(fig:plot-by-rules) plot the topline relationship between district-party ideology and CF scores for candidates running in states with different levels of primary openness.
Data on primary systems come from @boatright-et-al:2017:primary-timing-data for 2012 and 2014, and I coded 2016 by consulting the National Conference of State Legislators, Ballotpedia, and OpenPrimaries.org.^[
  Accessed May 27, 2020.
]
I code primary rules using a three-category scheme.
"Closed" primaries allow only pre-registered partisans to participate in a primary election.
"Semi-closed" primaries are closed to party registrants, but they allow independent or non-partisan voters to choose which primary in which they wish to participate.
Lastly, "open" primaries allow any eligible voter to participate in any party's primary.
I code nonpartisan blanket and top-two primaries as "open."
I choose a coarser three-level scheme over the five-level scheme in @mcghee-et-al:2014:nomination-systems because it is unlikely that voters process the fine legal differences that lead the authors to classify (for instance) "semi-closed" states and "semi-open" states differently.
The three-part scheme is also more specific than the two-part open/closed scheme used by @hill:2015:nominating-institution, since it is difficult to group independent and non-partisan participation in semi-closed states as either closed or open.

```{r plot-rules-means, include = TRUE, out.width = "100%", fig.width = 8, fig.height = 3.5, fig.cap = "Average CF scores candidate positioning in states with closed, semi-closed, and open primary rules.", fig.scap = "Average CF scores in states with closed-semi-closed, and open primary rules."}
```

Conventional wisdom about primary openness implies that closed primaries should produce more extreme candidates, and open primaries should produce more moderate candidates.
Figure \@ref(fig:plot-by-rules), which plots the average CF score for Republicans and Democrats under each primary system, contradicts this hypothesis.^[
  Estimates are calculated from a linear regression on indicator variables for each primary system type with group-clustered standard errors.
]
Democrats are in fact more progressive and Republicans more conservative in states with increasingly open primary participation rules, which is the opposite direction of the commonly hypothesized pattern.
Figure \@ref(fig:plot-by-rules) goes on to plot the linear relationship between CF scores and district-party ideology in each state to see if candidates in closed primaries are more responsive to district-party ideology. 
The relationships do not support the primary rules hypoethesis either.
While Republican candidates are indeed least sensitive to local partisan ideology in states with the model open rules—indeed the point estimate of the relationship is negative—they are _most_ sensitive in semi-closed rather than closed states.
The evidence from Democrats is even less consistent with the primary rules hypothesis.
Democrats in semi-closed systems are also most responsive to district-party ideology, and they are less sensitive to district-party ideology in closed primary systems than they are in open systems.

```{r plot-by-rules, include = TRUE, out.width = "100%", fig.width = 9, fig.height = 4.5, fig.cap = "District-party ideology and candidate positioning in states with closed, semi-closed, and open primary rules.", fig.scap = "District-party ideology and candidate positioning in states with different primary rules."}
```

The descriptive results from Figures \@ref(fig:plot-by-party) through \@ref(fig:plot-by-rules) inform a few modeling choices for the causal analysis to follow. 
Because incumbency status appears to modify the relationship between citizen and candidate ideology, some of the analysis below estimates the effect of district-party ideology using subsets of data on incumbents, challengers, and open seat candidates. 
By comparison, estimates exhibit no clear time variation, so I choose to pool election cycles into one model, using fixed effects where appropriate to the design, rather than estimating entirely separate models for different cycles.
And although the descriptive relationships were broadly similar for both parties—contradicting an "asymmetric parties" prediction that Republicans would be less responsive to district party ideology as well as the @clinton:2006:constituent-representation finding that Republicans are _more_ responsive— the variables that could confound the relationship between district-party ideology and candidate ideology are likely to differ dramatically across parties.
In order to increase the credibility of the selection-on-observables regression design, I therefore estimate models for Democrats and Republicans separately.


```{r remove-edta}
rm(list = c("full_data", "cycle_fit", "cycle_sum", "eda_fits", "incum_fit", "incum_sum", "party_fit", "party_sum", "primary_fit", "primary_sum", "rule_means"))
```


## The Causal Effect of District-Party Ideology

The descriptive picture in Figures \@ref(fig:plot-by-party) through \@ref(fig:plot-by-rules) are suggestive about the relationship between district-party ideology and candidate ideology, but the correlational analysis is insufficient to identify the causal effect of the partisan constituency.
As with many regression-based analyses using observational data, we are concerned about variables that confound the relationship between district-party ideology and candidate positioning—district characteristics that affect the degree of conservatism among both voters and candidates simultaneously.
Even more troublesome than confounding is the causal structure linking theoretical components of the strategic positioning dilemma: how the ideological locations of the partisan constituency _and_ the total district constituency affect one another, and how they jointly influence a candidate's positioning calculus.

```{r plot-barry}
tribble(
  ~ x, ~ actor, ~ symbol,
  1, "Partisan\nConstituency", "bar(theta)[g]",
  2.2, "Primary\nCandidate", "CF[i]",
  4, "District\nConstituency", "V[d]"
) %>%
  ggplot() +
  aes(x = x, y = 0) +
  annotate(
    geom = "segment", 
    x = 0, xend = 5, 
    y = 0, yend = 0
  ) +
  geom_point(size = 2) +
  geom_text(aes(y = -2, label = actor)) +
  geom_text(aes(y = 1, label = symbol), parse = TRUE) +
  coord_cartesian(xlim = c(0, 5), ylim = c(-4, 4)) +
  theme_void() +
  NULL
```

The strategic positioning dilemma (SPD) describes the campaign incentives that arise when a candidate chooses their campaign's ideological location for a multi-stage campaign season. 
Let $\text{CF}_{i}$ represent the campaign position for candidate $i$ in left-right ideological space. 
The theory states that candidates optimize their chances of winning by taking a position between the ideological location of their partisan constituency, denoted $\bar{\theta}_{g}$ for the district-party group $g$ in which the candidate runs, and the ideological median among the district constituency, denoted $V_{d}$ for the district $d$ where group $g$ resides.^[
  We distinguish individual candidates $i$ from district-party groups $g$ and districts $d$, because every district contains two major party groups, and every group can contain multiple primary candidates in a given election cycle.
]
Figure \@ref(fig:plot-barry) plots a hypothetical candidate's location between the partisan and district constituencies.
Whether the candidate positions themselves closer to the partisan constituency or to the district constituency is a function of the candidate's perceived degree of electoral threat from each constituency.
In an electorally safe district, the candidate of the advantaged party is reasonably assured to win the general election, so they may take a campaign position closer to the partisan constituency in order to neutralize the threat from other partisan candidates in the primary election.
In a competitive district, the candidate faces greater general election competition, so they position themselves closer to the district constituency to avoid alienating moderate voters who could decide the election [@aldrich:1983:downsian-parties; @burden:2001:polarizing-primaries].
As it relates to causal inference, the theoretical setup implies a causal effect of the primary constituency on candidate positioning (a causal path $\bar{\theta}_{g} \rightarrow \text{CF}_{i}$) and a causal effect of the district constituency on candidate positioning ($V_{d} \rightarrow \text{CF}_{i}$).

```{r plot-barry, include = TRUE, fig.scap = "Key variables in the strategic positioning theory.", fig.cap = "Spatial representation of key variables affecting the strategic positioning dilemma. ", out.width = "100%", fig.width = 7, fig.height = 3}
``` 


```{r problem-dag}
dag_data <- 
  dagify(
    CF ~ I + V + U,
    V ~ I + U,
    exposure = "I",
    outcome = "CF",
    coords = tribble(
      ~ name,      ~ x,    ~ y,
      "I",       1,   1,
      "CF",       3,   1,
      "V",       2,   0,
      "U",      3,      0
    ),
    labels = c(
      "I" = "District-Party Ideology",
      "CF" = "Candidate Positioning",
      "V" = "District Voting"
    )
  ) %>%
  tidy_dagitty() %>%
  # node_parents("CF") %>%
  mutate(
    pt_label = case_when(
      name == "I" ~ "bar(theta)[g]",
      name == "CF" ~ "CF[i]",
      name == "V" ~ "V[d]",
      name == "U" ~ "U"
    )
  ) %>%
  print()
```

```{r structure-dag}
structure_dag <- dag_data %>%
  filter(name != "U") %>% 
  ggplot() +
  aes(x = x, y = y, xend = xend, yend = yend) +
  geom_dag_edges() + 
  geom_dag_point(color = "gray80") +
  geom_dag_text(
    aes(label = pt_label), 
    parse = TRUE, 
    color = "black",
    family = font_fam
  ) +
  theme_mgd_dag() +
  theme(legend.position = "none") +
  expand_plot(
    expand_x = expansion(c(0.1, 0.1)), 
    expand_y = expansion(c(0.35, 0.2))
  ) +
  labs(
    x = NULL, y = NULL,
    title = "SPD Causal Structure"
  ) +
  NULL  
```

```{r plot-problem-dag}
problem_dag <- 
  ggplot(dag_data) +
  aes(x = x, y = y, xend = xend, yend = yend) +
  geom_dag_edges(
    data_directed = 
      filter(dag_data, ((to == "V") | (name == "U")) == FALSE),
  ) +
  geom_dag_edges(
    data_directed = filter(dag_data, (to == "V") | (name == "U")),
    edge_color = primary
  ) +
  geom_dag_point(aes(color = (name == "U"))) +
  geom_dag_text(
    aes(label = pt_label), 
    parse = TRUE, 
    color = "black",
    family = font_fam
  ) +
  scale_color_manual(values = c("TRUE" = primary, "FALSE" = "gray80")) +
  annotate(
    geom = "text",
    label = TeX("Controlling for $V_{d}$ opens path through U"),
    x = 3, y = 0,
    hjust = 1, vjust = 4,
    size = 4
  ) +
  theme_mgd_dag() +
  theme(legend.position = "none") +
  expand_plot(
    expand_x = expansion(c(0.1, 0.1)), 
    expand_y = expansion(c(0.35, 0.2))
  ) +
  labs(
    x = NULL, y = NULL,
    title = "Why Conditioning Fails"
  ) +
  NULL  
```


```{r combo-dag}
structure_dag + problem_dag
```

This analysis proposes an even more specific causal structure, the details of which are crucial for the research design and statistical approach.
I invoke a causal model where the party constituency location affects both the district constituency location and the candidate location, but the district location only affects the candidate location.
The diagram in the left half of Figure \@ref(fig:combo-dag) captures this structure.
A causal structure where the party location affects the district location, but not the other way around, makes sense by appealing to the spatial theory underpinnings of the SPD. 
The party location and the district location are aggregations of many individual constituents who each have ideological ideal points. 
The district constituency contains all of the party constituency as well as any other constituent who has a different party affiliation or no party affiliation.
This means that if we could causally intervene on the party constituency location by, for example, shifting it to the left, this is entails a leftward shift among the individual partisans in that constituency.
Because these partisan individuals are also members of the district constituency, this _ceteris paribus_ intervention on the party location also directly affects the district location, justifying the causal path $\bar{\theta}_{g} \rightarrow V_{d}$.
From a spatial theory point of view, the only way to intervene on a party location with no downstream effect on the district location would be to introduce an offsetting shift in the ideal points of constituents outside that party or an offsetting change in the partisan composition of constituents in district overall, neither of which is entailed by a causal intervention on the party location.
Furthermore, intervening on the location of the _district_ has no necessary effect on the party location.
This is because the district location is affected by factors other than the partisan constituency, namely the ideal points of constituents outside that partisan constituency or the relative sizes of partisan constituencies within the district.^[
  If we generalize the SPD to a panel data framework, we can stipulate a mechanism by which past district voting may affect future district-party ideology through a thermostatic opinion mechanism: heavy Democratic voting in one election leads to a Democratic presidency, which causes issue opinions across the country to become more conservative.
  The data in this project are unable to capture this mechanism because district-party ideology is measured for a district-party group over a districting cycle, but this is something that researchers could explore if they approach primary representation through a dynamic causal inference framework [@blackwell-glynn:2018:causal-TSCS; @imai-kim:2019:fixed-effects-causal-inference].
]


```{r combo-dag, include = TRUE, fig.width = 10, fig.height = 5, out.width = "100%", fig.scap = "Causal diagram of the strategic positioning dilemma", fig.cap = "Left: A causal diagram for the strategic positioning dilemma. The district location $V_{d}$ is a collider between district-party ideology $\\bar{\\theta}_{g}$ and the candidate position $\\text{CF}_{i}$. Right: Conditioning on post-treatment variables can bias causal estimates by creating artificial associations through unobserved confounders."}
```

If our primary interest is the treatment effect of district-party ideology on candidate positioning, but the district location also affects candidate positioning, it is a natural impulse to want to condition on some measure of district preferences.
For instance, the previous two-party presidential vote share is an available signal of district-level preferences that candidates can consult when they position themselves, so researchers may control for presidential voting in a district in order to isolate the effect of district-party ideology on candidate positioning.
This is similar to the motivation of @clinton:2006:constituent-representation, who compared incumbent responsiveness to district median preferences vs party median preferences by including measures of each variable in a regression.
Because the district location is a post-treatment variable, or a "collider" [@pearl:2009:causality] on the causal path from the party location to candidate location ($\bar{\theta}_{g} \rightarrow V_{d} \rightarrow \text{CF}_{i}$), identifying the effect of district-party ideology separately from the overall district effect is more complicated than controlling for the presidential vote in a regression.
This is because conditioning on a collider variable can bias causal effects by opening unblocked causal paths from treatment to outcome through unobserved confounders.
This problem is diagrammed in the left half of Figure \@ref(fig:combo-dag), which shows how conditioning on the presidential vote, a measure of $V_{d}$, opens a new pathway $\bar{\theta}_{g} \rightarrow V_{d} \rightarrow U \rightarrow \text{CF}_{i}$, biasing the estimated causal effect of $\bar{\theta}_{g}$.
At the same time, doing nothing to adjust for aggregate district preferences may identify the total effect of the district-party constituency under certain assumptions, but it would not detect whether presidential voting absorbs all of the effect of the partisan constituency.
There would be no way to contrast the unique impact of the partisan constituency from its downstream effect on overall district voting.

This analysis resolves this problem by using sequential $g$-estimation to identify a quantity called the average controlled direct effect (ACDE) of district-party ideology on candidate positioning [@vansteelandt:2009:direct-effects; @acharya-blackwell-sen:2016:direct-effects].
In terms of potential outcomes, let $\text{CF}_{i}\left( \bar{\theta}_{g}, V_{d}(\bar{\theta}_{g}) \right)$ be candidate $i$'s CF score as a function of district-party ideology and the past presidential vote, which represents district-level preferences $V_{d}$ and is itself a function of district-party ideology.
The controlled direct effect (CDE) for a unit $i$ is the difference in CF scores for different district-party ideology treatments, holding the presidential vote fixed at some value $v$.
\begin{align}
  \text{CDE}_{i}\left(\theta, \theta', m \right) &= 
    \text{CF}_{i}\left(\bar{\theta}_{g} = \theta, V_{d} = v \right) - \text{CF}_{i}\left(\bar{\theta}_{g} = \theta', V_{d} = v \right)
(\#eq:cde-unit)
\end{align}
The ACDE is the average of the CDEs if all units were fixed at the same mediator value $v$.

```{r create-g-dag}
g_dag <- 
  dagify(
    CF ~ I + V + Z + X + U1 + U2,
    V ~ I + X + Z + U1,
    Z ~ I + X,
    I ~ X + U2,
    exposure = "I", 
    outcome = "CF",
    coords = tribble(
      ~ name,  ~ x, ~ y,
      "I",       1,   2,
      "CF",       3,   1,
      "Z",       1,   0,
      "V",       2,   0,
      "X",       0,   1,
      "U1",      3, 0,
      "U2",      2.25,   2
    )
  ) %>%
  tidy_dagitty(layout = "auto") %>%
  mutate(
    label = case_when(
      name == "V" ~ "Past Presidential Vote",
      name == "I" ~ "Partisan Ideology",
      name == "CF" ~ "Candidate Position",
      name == "X" ~ "Pre-Treatment Confounders",
      name == "Z" ~ "Intermediate Confounders"
    ),
    pt_label = case_when(
      name == "V" ~ "V[d]",
      name == "I" ~ "bar(theta)[g]",
      name == "CF" ~ "CF[i]",
      name == "X" ~ "X[d]",
      name == "Z" ~ "Z[d]",
      name == "U1" ~ "U1",
      name == "U2" ~ "U2"
    )
  ) %>%
  print()
```

```{r g-dags}
base_dag <- g_dag %>%
  ggplot() +
  aes(x = x, y = y, xend = xend, yend = yend) +
  coord_cartesian(ylim = c(-0.25, 2.25)) +
  theme_mgd_dag() +
  labs(x = NULL, y = NULL) +
  expand_plot(
    expand_x = expand_scale(c(0.2, 0.2)), 
    # expand_y = expand_scale(c(0.2, 0.2))
  ) +
  NULL

mediator_dag <- base_dag +
  geom_dag_point(
    data = filter(g_dag, name %in% c("U2", "U1") == FALSE),
    color = "gray"
  ) +
  geom_dag_edges(
    data_directed = filter(g_dag, name %in% c("U2", "U1") == FALSE)
  ) +
  geom_dag_text(
    data = filter(g_dag, name %in% c("U2", "U1") == FALSE), 
    aes(label = pt_label),
    parse = TRUE,
    size = 3.5,
    color = "black"
  ) +
  labs(title = "\nStage 1", subtitle = "Identifies mediator effect\n") +
  NULL

exposure_dag <- base_dag +
  geom_dag_node(
    data = filter(g_dag, name %in% c("U2", "U1") == FALSE),
    internal_color = "gray",
    color = "white"
  ) +
  geom_dag_point(
    data = filter(g_dag, name %in% c("X", "I", "CF")),
    color = "gray"
  ) +
  geom_dag_edges(
    data_directed = g_dag %>%
      filter(
        to %in% c("Z", "V") | (name == "Z" & to == "CF"), 
        name %in% c("U1", "U2") == FALSE
      ),
    edge_linetype = "dashed", 
    edge_color = "gray"
  ) +
  geom_dag_edges(
    data_directed = g_dag %>%
      filter(
        (name %in% c("U1", "U2", "Z", "V")) == FALSE, 
        to %in% c("I", "CF")
      )
  ) +
  geom_dag_text(
    data = filter(g_dag, name %in% c("U1", "U2") == FALSE),
    aes(label = ifelse(name == "CF", "b(CF)[i]", pt_label)),
    color = "black",
    parse = TRUE,
    size = 3.5
  ) +
  labs(
    title = "\nStage 2", 
    subtitle = "Identifies controlled direct effect\nof treatment using demediated outcome"
  ) +
  NULL

confounding_dag <- base_dag +
  geom_dag_point(aes(color = name %in% c("U2", "U1"))) +
  geom_dag_edges() +
  geom_dag_text(
    aes(label = pt_label), 
    parse = TRUE, 
    size = 3.5,
    color = "black"
  ) +
  theme(legend.position = "none") +
  scale_color_manual(values = c("TRUE" = primary, "FALSE" = "gray")) +
  labs(title = "Violations of Sequential Ignorability", 
       subtitle = "In stage 1 (U1) and stage 2 (U2)")
```

```{r plot-g-dag}
g_layout <- "
AABB
#CC#
"

wrap_plots(
  A = mediator_dag, B = exposure_dag, C = confounding_dag, 
  design = g_layout
)
```


Sequential $g$-estimation is a structural modeling routine that estimates ACDEs by subtracting intermediary causal effects without creating collider bias [@acharya-blackwell-sen:2016:direct-effects; @vansteelandt:2009:direct-effects].
The routine requires adjusting for two sets of confounders: pre-treatment confounders $X_{d}$ that affect both district-party ideology and CF scores, and intermediate confounders $Z_{d}$ that affect both the presidential vote and CF scores.
Intermediate confounders are allowed to be affected by both pre-treatment confounders and district-party ideology.
The first graph in Figure \@ref(fig:plot-g-dag) diagrams the stipulated causal structure among the district-party ideology treatment, the presidential vote mediator, and both sets of confounders.
In the first stage of the model, the researcher estimates the effect of the mediator on the outcome variable, conditional on all confounders.
\begin{align}
\begin{split}  
  \E{\text{CF}_{i}\left(\theta, v\right) - 
     \text{CF}_{i}\left(\theta, v'\right) \mid 
       \bar{\theta}_{g} = \theta, X_{d} = x, Z_{d} = z 
     } = \hfill \\ 
     \hfill \qquad \qquad \E{\text{CF}_{i} \mid v, \theta, x, z} - 
     \E{\text{CF}_{i} \mid v', \theta, x, z}
\end{split}
(\#eq:po-stage-1)
\end{align}
The left side of Equation \@ref(eq:po-stage-1) represents the conditional effect of the mediator in terms of potential outcomes, and the right side is the quantity that can be estimated from observed data assuming that the mediator is conditionally ignorable given all confounders and has positive assignment probability [@acharya-blackwell-sen:2016:direct-effects;].
This specification blocks all back-door paths from $V_{d}$ to $\text{CF}_{i}$, which can be seen in the first panel of Figure \@ref(fig:plot-g-dag). 

The next step of sequential $g$-estimation is to subtract the effect of the mediator from the outcome, also known as "demediation" or "blip-down."
Demediation removes all variation in the outcome variable that is attributable to the causal effect of mediator.
This stage is algebraically equivalent to subtracting a _demediation function_ from the observed outcome.
The mediation function in terms of potential outcomes is as follows:
\begin{align}
  \delta_{d}\left(\theta, v, \bar{v}, x\right) &= 
  \E{\text{CF}_{i}\left(\theta, v \right) - \text{CF}_{i}\left(\theta, \bar{v} = 0.5 \right) \mid X_{d} = x}
  (\#eq:po-demediation-fn)
\end{align}
which represents the expected effect on CF scores by setting the presidential vote to its observed value versus some fixed reference value $\bar{v}$ for all units, conditional on $X_{d}$ [@acharya-blackwell-sen:2016:direct-effects].^[
  The model specification below functionally assumes to interactions between the presidential vote and intermediate confounders $Z_{d}$, so the specification of the demediation function in Equation \@ref(eq:po-demediation) does not depend on $Z_{d}$, although this assumption is not strictly necessary for nonparametric identification of the ACDE [@robins:1997:complex-longitudinal-data].
]
In this analysis, I fix the two-party presidential vote to $0.5$, an even split between Republicans and Democrats in the district. 
We subtract the demediation function from the original outcome to obtain the demediated CF score, $b\left(\text{CF}\right)_{i}$, which is equivalent to the potential CF score if all units had a presidential vote of $0.5$.
\begin{align}
\begin{split}
  b\left( \text{CF} \right)_{i} &= 
    \text{CF}_{i} - \delta_{d}\left(\bar{\theta}_{g}, V_{d}, \bar{v} = 0.5, x\right) \\
  \E{b\left(\text{CF}\right)_{i}}  &= \E{\text{CF}_{i}\left(\theta, V_{d} = \bar{v}\right)}
\end{split}
(\#eq:po-demediation)
\end{align}


```{r plot-g-dag, include = TRUE, fig.width = 9, fig.height = 10, out.width = "100%", fig.scap = "Sequential $g$-estimation using causal diagrams.", fig.cap = "Causal graphs describing the modeling problem and sequential $g$ estimation. The stage 1 graph identifies the effect of the past district voting ($V_{d}$) on candidate positioning ($\\text{CF}_{i}$). The stage 2 treatment-outcome model subtracts the district vote effect from candidate positions and identifies the effect of district-party ideology $\\bar{\\theta}_{g}$ on the demediated CF score $b(\\text{CF})_{i}$, which is equivalent to the controlled direct effect on the raw CF score. The final graph shows where unadjusted confounders violate the nonparametric causal identification assumptions in stage 1 ($U1$) and in stage 2 ($U2$)."}
```

Finally, the researcher estimates the effect of the treatment on the demediated outcome, which is equivalent to the controlled direct effect on the original outcome.
\begin{align}
\begin{split}
  \E{\text{CF}_{i}\left(\theta, \bar{v}\right) - 
     \text{CF}_{i}\left(\theta', \bar{v}\right) \mid x} &=
   \E{b\left(\text{CF}\right)_{i}\left(\theta\right) - 
      b\left(\text{CF}\right)_{i}\left(\theta'\right) \mid x} \\
   &= \E{b\left(\text{CF}\right)_{i} \mid \theta, x} - 
       \E{b\left(\text{CF}\right)_{i} \mid \theta', x}
\end{split}
(\#eq:po-stage-2)
\end{align}
The first statement in Equation \@ref(eq:po-stage-2) relates the controlled direct effect in terms of CF scores to the total effect on demediated CF scores. 
The second statement defines how the ACDE can be estimated with observable data under the assumption that assignment to district-party ideology ignorable and with positive probability given pre-treatment covariates [@acharya-blackwell-sen:2016:direct-effects].
The top-right graph in Figure \@ref(fig:plot-g-dag) shows how the demediation step recovers the controlled direct effect of district-party ideology.
Demediating the outcome removes all variation in CF scores caused by the presidential vote, so it deletes the path $V_{d} \rightarrow \text{CF}_{i}$ in the diagram.
In turn, there is no need to condition on the presidential vote $V_{d}$ in Equation \@ref(eq:po-stage-2) to identify the ACDE, even though the diagram shows that district-party ideology has an effect on the presidential vote.
Furthermore, the graph contains remains a causal path from the intermediate confounders $Z_{d}$ to the CF score, the stage-two model does not condition on these confounders because these pathways are a part of the district-party ideology's ACDE on CF scores.
It is worth noting here that if we estimate the stage-two model using the original CF score rather than the demediated CF score, this would estimate the total effect of district-party ideology.
This quantity can be valuable because valuable because the difference between the total effect and the controlled direct effect shows how much of the total effect flows is carried by a mediating mechanism.

The bottom graph in Figure \@ref(fig:plot-g-dag) shows where unmeasured confounding can violate the two ignorability assumptions required to estimate the ACDE. 
The stage-one model identifies the causal effect of the past presidential vote, so if an unmeasured variable (represented in the figure by $U1$) affects both district voting and CF scores, the mediator's effect is not identified. 
Similarly, the stage-two model does not identify the effect of district party ideology on the demediated CF score if they share an unmeasured cause $U2$.
Unmeasured variables in other locations of the graph certainly exist, but they do not violate the sequential ignorability assumptions unless they can be represented by an unblocked back-door path through $U1$ or $U2$.

With few exceptions, it is not typical for research on primary politics to incorporate explicit causal inference methodologies [@hall:2015:extremists; @fowler-hall:2016:convergence; @hall-thompson:2018:who-punishes; @doherty-et-al:2019:party-chairs].
Although many other studies use a selection-on-observables research design to study candidate positioning in primary elections, a major contribution of this study's research design is the use of structural causal modeling to define, identify, and estimate a specific causal quantity.

<!------- TO DO ---------
- Discuss potential violations of assumptions
- Simulate violated assumptions by way of correlated error parameters?
------------------------->

### Sequential $g$ implementation

The average controlled direct effect of district-party ideology on primary candidate CF scores is _nonparametrically_ identifying under SUTVA, sequential ignorability, and positivity.
I estimate the sequential $g$ model using a linear model specification laid out by @acharya-blackwell-sen:2016:direct-effects.
As with any linear model, this specification imposes additional functional form and distributional assumptions on the data, which are helpful for confounder adjustment in the absence of other design-based variation from instruments or discontinuities, but could lead to incorrect inferences if assumptions are false.
One goal for future work in this literature would be to combine the sequential $g$ structural model with semi- and non-parameteric estimation methods, an nascent area of work that exists largely outside of political science [@hill:2011:bart; @athey-at-al:2016:residual-balancing; @samii-et-al:2016:retrospective-causal-inference-ML; @chernozhukov-et-al:2017:double-ML; @wager-athey:2018:honest-causal-forests; @ratkovic:2019:rehabilitating-regression; @hahn-et-al:2020:bayesian-causal-forests]

This section lays out the linear specification for sequential $g$-estimation.
I define the model using notation that is general enough to apply to any subset of data where the model is estimated.
As mentioned above, I investigate subsets of data by incumbency and primary rules, and I estimate each model separately for Republicans and Democrats. 
The data contain measures of candidates $i$ in district-party groups $g$ in districts $g$.
Because all models are estimated separately for each party, groups and districts perfectly overlap.
Nonetheless, I use $g$ for variables that can vary across party within a district and $d$ for variables that are fixed for both parties in a district.
Because the estimation contains in two stages of regression modeling, I sometimes subscript some parameters with $1$ or $2$ to indicate which equation they belong to.

The first stage is a mediator–outcome model that estimates how the Republican two-party presidential vote in the past election $V_{d}$ affects the CF score of candidate $i$ within group $g$.
We set up the sequential $g$ method to control for the previous Republican presidential vote share in district $d$, denoted $\mathit{pvote}_{g}$.
This is done with the following multilevel regression model.
\begin{align}
\begin{split}
  \mathrm{CF}_{i} &= 
    a_0 + 
    \mu \mathrm{V}_{d[i]} + 
    \eta \bar{\theta}_{g[i]} + 
    \mathbf{x}_{d[i]}^{\intercal}\beta +
    \mathbf{z}_{d[i]}^{\intercal}\gamma +
    \alpha_{d[i]} + \epsilon_{i} \\
  \alpha_{d} &\sim \text{Normal}\left(0, \sigma_{\alpha}\right) \\
  \epsilon_{i} &\sim \text{Normal}\left(0, \sigma_{\epsilon}\right)
\end{split}
(\#eq:med-model)
\end{align}
<!------- TO DO ---------
- check on these assumptions
------------------------->
The group ideal point $\bar{\theta}_{g}$ is included in the regression as a control, so its coefficient $\eta$ is estimated as a nuisance parameter, as are the coefficients $\beta$ for district-level pre-treatment confounders $\mathbf{x}_{d}$, the coefficients $\gamma$ for district-level intermediate confounders $\mathbf{z}_{d}$, and the constant $a_{0}$.
Because the mediator is measured at the district level, I include a district error term $\alpha_{d}$ in addition to the candidate-level error term $\epsilon_{i}$.
This multilevel model accounts correlated error among candidates in the same district-party group, similar to clustering standard errors when a treatment is dosed at the cluster level.

We then use the estimates from the stage-1 model to demediate the CF score variable.
Because the first stage is a linear model, the demediation function has a straightforward parametric definition,
\begin{align}
  \delta_{d} &= \mu \left(\mathrm{V}_{d} - \bar{v} \right)
  (\#eq:blipdown-function)
\end{align}
where $\bar{v}$ is the reference value for the mediator where all units are fixed, which I set equal to $0.5$ to represent a 50-50 split in the previous two-party presidential vote.^[
  The demediation function can be more complex if the mediator's effect on the outcome is modeled with a more complex model containing interactions or nonlinearities.
]
The demediation function is subscripted $d$ because it varies across districts according to the observed value of the previous Republican vote share, which also entails that the demediation function is equivalent for all candidates in the same district-party group, regardless of their original CF score.
We calculate the demediated outcome $b(\text{CF})_{i}$ by subtracting each district's demediation function from its observed outcome value,
\begin{align}
  b\left(\mathrm{CF}\right)_{i} &= \mathrm{CF}_{i} - \delta_{d}
  (\#eq:blipdown-outcome)
\end{align}

The demediated outcome is then used in the second stage estimation of the controlled direct effect.
The second stage is different from the first stage in two ways.
First, because the demediated outcome fixes the value of the mediator, there is no more variation across observations that can be attributed to the mediator, so $V_{d}$ is omitted from the equation.
Second, intermediate confounders are omitted because they can be affected by district-party ideology, and as such should be left unadjusted in order to identify the ACDE.
This new equation is,
\begin{align}
\begin{split}
  b\left(\mathrm{CF}\right)_{i} &= 
    a_{1} +
    \tau \bar{\theta}_{g} + 
    \mathbf{x}^{\intercal}_{g[i]}\omega + 
    \nu_{d[i]} + u_{i} \\
  \nu_{d} &\sim \text{Normal}\left(0, \sigma_{\nu}\right) \\
  u_{i} &\sim \text{Normal}\left(0, \sigma_{u}\right)    
\end{split}
(\#eq:trt-model)
\end{align}
where $a_{1}$ is a constant, $\tau$ is the coefficient for district-party ideology, $\omega$ are coefficients for district-level pre-treatment confounders $\mathbf{x}_{d}$, $\nu_{d}$ is a district error term, and $u_{i}$ is a candidate error term.
In a linear model specification, $\tau$ measures the average total effect of a one-unit increase in district-party ideology on demediated CF scores, which is equivalent to the ACDE on the original CF scores.
More generally, the ACDE of setting district-party ideology from $\bar{\theta}'$ to $\bar{\theta}$ is as follows.^[
  Again, the exact formula for the ACDE depends on the model specification. 
  The linear model with no treatment interactions produces a simple linear ACDE definition, but a more complex model would entail a more complex formula.
]
\begin{align}
  ACDE(\tau, \theta, \theta') &= \tau \left(\theta - \theta'\right)
  (\#eq:general-ACDE)
\end{align}



### Bayesian modeling and interpretation

Another key methodological innovation in this chapter is embedding sequential $g$-estimation in a Bayesian framework.
Chapter \@ref(ch:causality) describes a number of special advantages for Bayesian causal modeling, stemming from the fact that Bayesian inference allows the researcher to conduct posterior inference about causal effects using probabilities: the treatment effect is _probably_ greater than $x$, where "probably" is defined in relation to an empirical cumulative probability distribution function of posterior samples.

The most important feature of Bayesian causal inference for this chapter is the fact that one posterior distribution quantifies uncertainty in all parameters from the multi-stage sequential $g$ method.
This is valuable because uncertainty in stages 1 and 2 are directly related to one another by way of the demediation function. 
Whereas non-Bayesian analysis requires either ad-hoc variance corrections for the multistage model or a bootstrapping approach [@acharya-blackwell-sen:2016:direct-effects], the posterior distribution from the Bayesian model captures all variances and covariances among model parameters by its very nature.
Inferences about the ACDE can then be expressed by marginalizing the posterior distribution with respect to these auxiliary model parameters, isolating the remaining dimension of the posterior corresponding to the ACDE.
Letting $\boldsymbol{\pi}$ represent all auxiliary model parameters, and using the definition of the ACDE in Equation \@ref(eq:general-ACDE), the posterior distribution for the ACDE is given by
\begin{align}
  \p{\tau \left(\theta - \theta'\right) \mid \mathbf{CF}} 
  &= 
  \int \p{\tau \left(\theta - \theta'\right), \boldsymbol{\pi} \mid \mathbf{CF}} \diff \boldsymbol{\pi},
  (\#eq:post-acde)
\end{align}
which is a the distribution of ACDE values that condition on the observed data and marginalize over the associated auxiliary parameter values.
In practice, we use posterior samples to approximate this posterior distribution by picking any two values $\theta$ and $\theta'$, extracting posterior samples for $\tau$, and calculating the ACDE for each sample iteration. 
Posterior expectations for the ACDE can be calculated, up to Monte Carlo error, by averaging the ACDE values from a draw of posterior samples.
Uncertainty intervals for the ACDE can be estimated by noting which posterior samples bound the inner 90 or 95% of posterior samples.

<!------- TO DO ---------
- should this go in Ch 3?
------------------------->
The joint posterior distribution is also essential for incorporating uncertainty in district-party ideal points themselves.
The IRT model in Chapter \@ref(ch:model) does not estimate district-party ideal points exactly. 
Instead, ideal points are estimated only up to a posterior distribution, with uncertainty that reflects both prior ignorance and a finite sample of polling data.
To estimate the effect of district-party ideology on candidate positioning, the causal analysis incorporates measurement error in ideal points "the Bayesian way," where posterior uncertainty from one analysis becomes prior uncertainty in later analyses.
One way to implement this "full uncertainty" would be to build one joint model containing both the IRT measurement model and causal inferential models, although this would be a burdensome feat of computer programming and computationally expensive to run each model. 
Instead, I approximate the joint model by constructing a prior for $\bar{\theta}_{g}$ in the causal model by approximating the posterior distribution from the IRT model.
This prior is constructed by defining the group ideal point $\bar{\theta}_{g}$ as an element of $\Theta$, the vector of all group ideal points, which gets a multivariate Normal prior.
\begin{align}
  \Theta &\sim 
    \mathrm{MultiNormal}\left( \hat{\Theta}, \hat{\Sigma}_{\Theta} \right) %_
  (\#eq:theta-prior)
\end{align}
The hyperparameters in the prior are estimated from MCMC samples for the ideal points.
The mean vector $\hat{\Theta}$ contains MCMC means for each ideal point, and the matrix $\hat{\Sigma}_{\Theta}$ contains variances for each ideal point on the diagonal and covariances between any two ideal points on the off-diagonals.
Because the IRT model partially pools ideal points using a hierarchical Normal regression, the multivariate Normal prior is a reasonable stand-in for representing prior ideal point uncertainty in causal analyses.

Including ideal point uncertainty as a prior distribution effectively adds a measurement error model overtop to the sequential $g$ analysis. 
Although @acharya-blackwell-sen:2016:direct-effects describe a variance estimator and a bootstrap method for dealing with multi-stage modeling uncertainty, neither of these methods is naturally suited to a measurement error context where an additional layer of ideal point uncertainty is represented in posterior samples.
Past research has explored the use of inverse-variance weighting to downweight observations with greater measurement uncertainty [e.g. @adolph-at-al:2003:wls-ei],
which accomplishes a similar goal as the prior distribution but throws out all prior information about the covariance between ideal points.
More recently, researchers have employed numerical methods for "uncertainty propagation," where the researcher estimates an uncertain quantity, simulates values from the quantity's posterior distribution, and pushes those simulated values through a downstream analysis. 
Quantities of interest are then averaged across the posterior simulations [see @kastellec-et-al:2015:scotus-electoral-connection p. 791; @caughey-warshaw:2018:dynamic-responsiveness p. 6; @caughey-warshaw:2019:subnational-opinion-review p. 360].
This is similar in spirit to "multiple overimputation" [@blackwell-et-al:2017:measurement-error], which extends multiple imputation to a measurement error setting by iteratively replacing mismeasured observations with draws from their posterior distribution.
This project regards these propagation methods as insufficiently Bayesian because they "cut" the flow of information between models. 
Posterior cutting allows model 1 to inform model 2, but model 2 can never inform model 1 [@plummer:2015:bayesian-cuts].
This can be an undesirable modeling property if the causal model can inform the measurement model [@treier-jackman:2008:latent-democracy].
For instance, if ideal points are related to candidate positioning, and ideal points are measured with error, then observing candidate positions can update our information about ideal points.
By specifying the prior directly and updating the parameters, there is no need for any additional imputation steps or post-estimation model averaging [@gelman-hill:2006:multilevel p. 542].

The Bayesian sequential $g$ approach, of course, requires priors for other model parameters as well.
As I describe below in Section \@ref(sec:g-data), most variables in the model are binary indicators or are standardized to be mean $0$ and variance $1$.
Furthermore, most of the outcome data in each model fall mostly in the $[-2, 2]$, so we can place standard Normal priors on the covariates without being overly informative about the covariate effects and introducing regularization bias [@hahn-et-al:2018:regularization-confounding].
Constants are given wider priors to account for the fact that not all predictors are exactly centered at means.
<!------- TO DO ---------
- do I change the prior scale for ideal points or anything?
------------------------->
\begin{align}
\begin{split}
  a_0, a_1 &\sim \text{Normal}\left(0, 5\right) \\
  \eta, \mu, \beta, \gamma &\sim \text{Normal}\left(0, 1 \right) \\
  \tau, \omega &\sim \text{Normal}\left(0, 1 \right)
\end{split}
(\#eq:g-coef-priors)
\end{align}
Both modeling stages contain Normal district-level error terms with estimated variances that facilitate partial pooling. 
These variances are themselves given half-Cauchy priors with weakly informative scale parameter values that are about half the range of the raw outcome data within each party.
\begin{align}
\begin{split}
  \alpha_{d} &\sim \text{Normal}\left(0, \sigma_{\alpha} \right) \\    \sigma_{\alpha} &\sim \text{Half-Cauchy}\left(0, 1 \right) \\
  \nu_{d}  &\sim \text{Normal}\left(0, \sigma_{\nu} \right) \\    \sigma_{\nu} &\sim \text{Half-Cauchy}\left(0, 1 \right)
\end{split}
(\#eq:g-ranef-priors)
\end{align}
And finally, each stage of the model has a Normal error term for candidates within districts. 
The variances for these errors are given half-Cauchy priors with wider scale values than the districts errors, since residual variation between any two candidates is likely larger than the variation between average candidates in any two districts.
\begin{align}
\begin{split}
  \epsilon_{i} &\sim \text{Normal}\left(0, \sigma_{\epsilon} \right) \\    \sigma_{\epsilon} &\sim \text{Half-Cauchy}\left(0, 2 \right) \\
  u_{i} &\sim \text{Normal}\left(0, \sigma_{u} \right) \\    \sigma_{u} &\sim \text{Half-Cauchy}\left(0, 2 \right)
\end{split}
(\#eq:g-resid-priors)
\end{align}



### Causal inference with multilevel data

The research question in this chapter presents us with multilevel data: how is the ideological positioning of primary candidates affected by the policy ideology of partisans in their district, when there are potentially multiple candidates per district?
In this scenario, the outcome is a variable specific to an individual candidate $i$, but the treatment is fixed for an entire district-partisan group $g$. 
This introduces a few issues for statistical assumptions and causal assumptions.

On the statistical front, multilevel models bias coefficient estimates when the aggregate errors are not exchangeable.
Mechanically, this is similar to "omitted variable bias" in a single-level regression.
Although this concern is well founded for many multilevel models, for these models we can be less concerned.
Because all predictors in these regressions are measured at the district level, the district error term is analogous to an error term that we would obtain by averaging every candidate's CF score within a district-party group and running a single-level regression on those averages.
Both of these model specifications require an exchangeable errors assumption at the district level.
The only difference for the models in this analysis is the additional candidate-level errors, but this too is a non-issue. 
Averaging candidate data within each district would invoke a similar assumption about the exchangeability of candidates given the district, otherwise it would be inappropriate to average data within a district.

Even though the multilevel model has similar assumptions as a regression on averages, it has certain benefits that are convenient for these data.
Because the number of candidates in a district isn't fixed across all districts, we would expect heteroskedasticity in a regression-on-averages model, since some districts would have higher variances due to fewer candidates.
In the extreme case, if a district contained only one unopposed primary candidate, a naïve estimator would be unable to distinguish district-level variance from candidate-level variance.
The multilevel model addresses this by estimating the distributions of district errors and candidate errors simultaneously, enhancing the model's ability to recognize when larger district errors are caused by signal versus noise.
Errors from smaller districts borrow more information from the overall distribution of districts, downweighting the contributions of smaller districts by shrinking their error terms toward a mean of zero.
This has a similar intuition as a weighted least squares regression on the district-averaged data, where groups with more observations are more informative about global parameters and receive greater weight.
This is yet another example where priors stabilize pathological model behavior, underscoring the flexibility afforded by Bayesian model-building for confronting the idiosyncrasies of a dataset with tactics that are both intuitive and feasible.
<!-- At a technical level, the model is able to avoid estimating individual random effects at all through a clever model parameterization that marginalizes over the distribution of district effects, which I explain in Section \@ref(sec:stan-g). -->

The multilevel data structure also raises causal inference issues that are worth clarifying.
As with many causal models where treatments are assigned to clusters of observations, it makes sense to consider SUTVA as violated within a cluster: there is no way for one candidate in a district to be treated by a different district-party ideology than other candidates.^[
  Candidates may vary in their ability to perceive district-party ideology, but that might also be described as an issue of treatment compliance or treatment effect heterogeneity.
]
The positioning of one candidate may also affect the positioning of another, which could violate the "no interference" component of SUTVA. 
Under this violation, the treatment effect at the individual level is not identified.
If SUTVA holds _between_ groups, however, it is possible to identify a treatment effect by considering average effects across groups [@Hill:2013:multilevel-causal-inf]. 
In potential outcomes notation, even if we can define potential outcomes at the individual level ($\mathit{CF}_{i}(\bar{\theta}_{g[i]})$), the lowest level where we could credibly _identify_ treatment effects would be the group level, where the potential outcome for a group is the average outcome within the group ($\overline{\mathit{CF}}_{g}\left(\bar{\theta}_{g}\right)$).
This is consistent with the multilevel model setup that we have so far, where the ACDE is a function of aggregate data and aggregate parameters only (see Equation \@ref(eq:general-ACDE)).

There are a few additional considerations for causal inference with hierarchical data that, although I do not pursue these threads in this project, could be relevant for future work with similar data.
A correlation between treatment effects and group size may arise if a crowded primary field causes larger treatment effects because stiffer competition leads candidates to be more responsive to district-party ideology.
On the other hand, more crowded fields would lead to smaller treatment effects if candidates take heterogeneous ideological positions to differentiate themselves.
If treatment effects are correlated with group size, then the average causal effect for a candidate is not equivalent to average difference among groups.
Instead, the average effect for candidates must be a size-weighted average of group effects [@Hill:2013:multilevel-causal-inf].
I do not pursue this possibility in this project because these dynamics are not identifiable with data on primary candidates only, since incumbents may take ideological positions to deter challengers even if no challengers actually emerge.
As such, the observed number of candidates in a district may not capture the true degree of primary threat [@hirano-et-al:2010:primary-polarization; @maisel-stone:1997:candidate-emergence; @stone-mailsel:2003:potential-candidate-calculus].

One additional consideration for group-level effects is the possibility that group size affects treatment assignment.
This may be true if the long-run dynamics of primary competition within a district-party have feedback effects on local ideology, for instance if partisan constituents become more ideologically aware by experiencing stronger intra-party competition in their district, or less ideological after a long period of representation by a single incumbent with little primary competition.
There is evidence that primaries contain more ideological campaign content in certain periods of heightened partisan mobilization [@boatright:2013:getting-primaried], which could increase voters' ideological awareness as well.
Whether voters are responding to primary competition in the district _per se_ or to a national state of partisan agitation is an interesting but thoroughly challenging question for future researchers to explore, were they to extend the data and methods in this project to a greater number of election cycles and dynamic causal modeling approaches [e.g. @blackwell-glynn:2018:causal-TSCS; @imai-kim:2019:fixed-effects-causal-inference].


### Data {#sec:g-data}

For the CF score outcome measure, I specifically use the dynamic CF score provided by @bonica:2019:dime, which is re-estimated for each two-year FEC cycle.
The measure of district-level partisanship, the mediator in the sequential $g$-estimation routine, is the two-party Republican presidential vote share from the previous election cycle, which is provided and matched to candidacies by @bonica:2019:dime.
District-party ideology $\bar{\theta}_{g}$, the treatment variable, is measured from the ideal point model in Chapter \@ref(ch:model).

Pre-treatment confounders $\mathbf{x}_d$ are included to identify the effect of the presidential vote in stage 1 and the effect of district-party ideology in stage 2. 
These covariates were organized and matched to primary candidacies by the Primary Timing Project by @boatright-et-al:2017:primary-timing-data
District demographic variables (sourced originally from the American Community Survey) include district median income, population density, and land area, as well the percent of a district population that is White, Latino, college educated, below the federal poverty line, unemployed, employed in the service industry, employed in blue-collar jobs, aged 28–24, and aged 65+.
The @boatright-et-al:2017:primary-timing-data data also provide @mayhew:1986:placing-parties's five-level "traditional party organization" and binary "persistent factionalism" classifications for state level [@mayhew:1986:placing-parties].
The stage-1 model also contains intermediate controls $\mathbf{z}_{d}$ for identifying the effect of the past presidential vote on CF scores.
These variables include the district-party ideal point for the _other_ party group in the same district, because both parties should partially affect aggregate district voting, and year fixed effects to capture average shifts in CF scores that are correlated with average shifts in presidential voting.^[
  Fixed effects are not included in pre-treatment controls because district-party ideology is fixed across the redistricting cycle, so they do not improve causal identification in stage 2.
]

All controls except for the fixed effects and binary indicators from @mayhew:1986:placing-parties are centered at their means and scaled by their standard deviations.
This makes it easier to specify priors for coefficients, since standardized coefficients are unlikely to exceed a $1$ except when predictors are highly correlated.
District-party ideology $\bar{\theta}_{g}$, the treatment variable, is measured on its original scale anchored by the item parameters in the Chapter \@ref(ch:model) model.
The presidential vote variable is centered at its reference value for demediation, $0.5$, and then divided by 10 so that a one-unit change in the model represents a 10 point change in vote share.
CF scores are measured on their original scale, which spans roughly as wide as $-5$ to $5$ across both parties, both the vast majority of Democrats occupy values in $[-2, 0]$ and Republicans in $[0, 2]$.
<!------- TO DO ---------
- do we normalize in the data analysis?
------------------------->





## Findings {#sec:g-findings}

<!-- 
  bring in data from model fits and ideal point priors
-->


```{r input-data}
# data and ideal point hyperparam estimates
# full data included above
theta_stats <- 
    here("data", "_clean", "ideal-point-priors.rds") %>%
    read_rds()

theta_stats <- list(
  mean_all = theta_stats$mean_all, 
  cov_all = theta_stats$cov_all
)
```

```{r read-fits}
mcmc_dir <- file.path("data", "mcmc", "4-positioning")

# random is THE OFFICIAL FIT
vb_fits <- 
  here(mcmc_dir, "local_g-grid-vb.rds") %>%
  read_rds() %>%
  ungroup() %>%
  arrange(party_num, incumbency, prim_rules) %>%
  select(everything(), stanfit = vb_random, -vb_fix, -vb_id) %>%
  mutate(stantidy = map(stanfit, tidy, conf.int = TRUE, conf.level = 0.9)) %>%
  print(n = nrow(.))
```







<!-- 
  create table of sample sizes in each model run
-->

```{r vb-table}
vb_table <- vb_fits %>%
  transmute(
    Party = names(party_code_colors)[party_num], 
    Incumbency = 
      str_glue("{incumbency}s") %>% 
      fct_relevel("Alls", "Incumbents", "Challengers"),
    `Primary Rules` = 
      case_when(
        prim_rules == "semi" ~ "Semi-Closed", 
        TRUE ~ tools::toTitleCase(prim_rules)
      ) %>%
      fct_relevel("All", "Closed", "Semi-Closed", "Open"),
    N = map_chr(data, ~ nrow(.) %>% comma(accuracy = 1)),
  ) %>%
  arrange(Party, Incumbency, `Primary Rules`) %>%
  pivot_wider(
    names_from = "Party",
    values_from = "N",
  ) %>%
  mutate(
    `Primary Rules` = str_glue("{`Primary Rules`} (D = {D}, R = {R})"),
    `Incumbency` = str_glue("{`Incumbency`} (D = {D}, R = {R})")
  ) %>%
  print()

vb_kable <- bind_cols(
  filter(vb_table, str_detect(Incumbency, "Alls") == FALSE) %>% 
    select(Incumbency),
  filter(vb_table, str_detect(`Primary Rules`, "All") == FALSE) %>% 
    select(`Primary Rules`)
  ) %>%
  mutate(
    `Full Sample` = vb_table %>%
      filter(
        str_detect(Incumbency, "Alls"), 
        str_detect(`Primary Rules`, "All")
      ) %$%
      c(
        str_glue("Democrats = {D}"), 
        str_glue("Republicans = {R}"),
        ""
      )
  ) %>%
  select(`Full Sample`, 
         `By Incumbency Status` = Incumbency, 
         `By Primary Rules` = `Primary Rules`) %>%
  print()
```

```{r n-kable, include = TRUE}
kable(
  vb_kable,
  short.caption = "Sample sizes in all sequential $g$ models.",
  caption = "Sample sizes in all sequential $g$ models.",
  booktabs = TRUE
)
```




I estimate models in several subsets of data.
First, I estimate separate models for all Democratic and all Republican candidates in the sample.
I then estimate models that divide each partisan subsample into incumbent candidates, challengers of incumbents, and candidates running for an open congressional seat.
Finally, I estimate separate models for candidates running in closed primaries, semi-closed primaries, and open primaries. 
Table \@ref(tab:n-kable) shows the sample sizes in each model subset.

For the sake of computation time, I estimate these models by approximating the posterior distribution using the mean-field variational Bayes routine available in Stan [@kucukelbir:2015:ADVI].
Variational Bayesian inference (VB) finds and optimizes a simpler distribution that is similar to the true posterior distribution in terms of Kullback–Leibler divergence [@grimmer:2011:VB-intro]. 
Variational estimators are asymptotically consistent and can be used to estimate any Stan model. 
But because they require approximations, samples from the approximate distribution tend to underestimate the variance in the true posterior distribution [@wang-titterington:2012:VB-asymptotics].
The benefit, however, is that models that would take hours to estimate using MCMC can be estimated using VB in roughly one minute, which is extremely valuable for building and estimating the 14 models included in this chapter.

```{r theta-prepost}
# match each theta to its group
# scale each prior theta within model subset to match model rescaling

theta_prepost <- vb_fits %>%
  select(-data, -stanfit) %>%
  # unnest(stantidy) %>%
  mutate(
    stantidy = map(
      .x = stantidy,
      .f = ~ {
        .x %>%
        filter(
          str_detect(term, "theta\\["), 
          (str_detect(term, "coef") == FALSE)
        )
      }
    ),
    # stangroup = parse_number(term),
    group = map2(
      .x = stantidy,
      .y = stan_data,
      .f = ~ {
        sg <- .x %>% pull(term) %>% parse_number()
        dn <- sort(unique(.y$group))[sg]
      }
    ),
    prior_mean = map(
      .x = group,
      .f = ~ {
        themean <- theta_stats$mean_all$theta_mean[.x]
        thesd <- sqrt(diag(theta_stats$cov_all)[.x])
        tibble(
          prior_mean = themean,
          lower = prior_mean - 2*thesd,
          upper = prior_mean + 2*thesd
        )
      }
    )
  ) %>%
  unnest(cols = c(stantidy, group, prior_mean)) %>%
  ungroup() %>%
  select(-stan_data) %>%
  print()
```


```{r plot-theta-prepost}
theta_prepost %>% 
  filter(incumbency == "All" & prim_rules == "All") %>%
  ggplot() +
  aes(x = prior_mean, y = estimate, color = as.factor(party_num)) +
  geom_pointrange(aes(ymin = conf.low, ymax = conf.high)) +
  geom_pointrange(aes(xmin = lower, xmax = upper)) +
  geom_point(size = 0.5, color = "black") +
  geom_abline() +
  coord_fixed() +
  scale_color_manual(values = party_factor_colors) +
  labs(
    x = TeX("Ideal Point Prior (mean $\\pm$ 2 sd)"),
    y = "Ideal Point Posterior\n(mean and 90% interval)",
    title = "Ideal Point Uncertainty in Sequential-G",
    subtitle = 'How model "updates" ideal point priors'
  ) +
  theme(legend.position = "none")
```

Before turning to the results, recall that a distinguishing feature of the Bayesian approach is the use of priors to represent measurement error in district-party ideal points.
This is an intuitive solution to the problem of uncertainty propagation because uncertainty in causal effects naturally reflects uncertainty in the data by marginalizing over the ideal points.
Another interesting consequence is that the posterior distribution for the ideal points could be different from the prior, depending on the information that the inferential the model can provide about the values of the ideal point parameters.
I plot the prior and posterior distributions for ideal points alongside one another in Figure \@ref(fig:plot-theta-prepost), using points to represent prior and posterior means and bars to represent uncertainty intervals.
Posterior estimates come from the models estimated on the full samples of Democrats and Republicans.
The data fall along the 45-degree line, indicating that prior and posterior ideal points are similar to one another, which is a sensible result that increases our confidence in the computational accuracy of the model.
The similarity between prior and posterior ideal points is also convenient for understanding the regression results, because coefficients can be interpreted in the original scale of the data without any need to post-process results into a familiar scale.^[
  In a regression context like this, the ideal points and their regression coefficient are not mutually identifiable because each could be arbitrarily scaled in offsetting ways.
  Estimation with MCMC may suffer under this non-identifiability by "wandering" through the weakly identified regions of parameter space, which can be corrected by post-processing parameter samples by applying scale constraints to each MCMC interaction.
  The variational algorithm is deterministic and does not wander in the same way, which eliminates the need to post-process estimates to recover sensible answers.
]

```{r plot-theta-prepost, include = TRUE, fig.width = 6, fig.height = 6, out.width = "60%", fig.scap = "Prior and posterior distributions for ideal points in sequential $g$ model", fig.cap = "Marginal prior and posterior distributions for ideal points in sequential $g$ model."}
```




```{r tidy-coefs}
# categorize params
tidy_coefs <- vb_fits %>%
  select(-data, -stanfit, -stan_data) %>%
  unnest(stantidy) %>%
  mutate(
    prefix = case_when(
      str_detect(term, "coef") ~ "Causal Parameters",
      str_detect(term, "med") & 
        (str_detect(term, "wt") | str_detect(term, "const")) ~ 
        "Med Nuisance",
      str_detect(term, "trt") & 
        (str_detect(term, "wt") | str_detect(term, "const")) ~ 
        "Trt Nuisance",
      str_detect(term, "sigma") ~ "Scale Terms"
    )
  ) %>%
  filter(is.na(prefix) == FALSE) %>%
  print()

std_coefs <- vb_fits %>%
    mutate(
      std = map2(
        .x = stantidy,
        .y = stan_data,
        .f = ~ {
          tibble(
            sdx = sd(.y$theta_mean),
            sdy = sd(.y$y),
            b = filter(.x, term == "coef_theta_trt") %>% pull(estimate),
            beta = b*(sdx / sdy)
          )
        }
      )
    ) %>%
    select(-(data:stantidy)) %>%
    unnest(std) %>%
    print()
```

```{r pretty-coefs}
# coef names from sequential-g.R
X_names <- c(
  "% White",
  "% Latino",
  "% College",
  "Median Income",
  "% Poverty",
  "% Unemployed",
  "% Service Sector",
  "% Blue Collar",
  "% Age 18–24",
  "% Age 65+",
  "Pop. Density",
  "Area (sq.mi.)",
  "TPO 2",
  "TPO 3",
  "TPO 4",
  "TPO 5",
  "Factionalism"
) 

Z_names <- c(
  "Opp. Ideal Pt.",
  "2014 Cycle",
  "2016 Cycle" 
)

# combine names,  use indices later for matching
XZ_names <- c(X_names, Z_names) %>% print()

# pretty coefs for ALL SUBSETS
pretty_coefs <- tidy_coefs %>%
  mutate(
    term_label = case_when(
      str_detect(term, "wt") ~ XZ_names[parse_number(term)],
      str_detect(term, "const_") ~ "Constant",
      term == "coef_theta_trt" ~ "CDE:\nDistrict-Party Ideology",
      term == "coef_mediator" ~ "Previous Rep. Vote",
      term == "coef_theta_med" ~ "District-Party Ideology\n(Stage 1)",
      str_detect(term, "hypersigma") ~ "District SD",
      str_detect(term, "sigma") ~ "Residual SD",
      TRUE ~ term
    ),
    term_label = fct_relevel(
      term_label, 
      "Constant",
      "Previous Rep. Vote",
      "District-Party Ideology\n(Stage 1)",
      "CDE:\nDistrict-Party Ideology",
      "Opp. Ideal Pt.",
      "Median Income",
      "% College",
      "% Poverty",
      "% Unemployed",
      "% Blue Collar",
      "% Service Sector",
      "% White",
      "% Latino",
      "% Age 18–24",
      "% Age 65+",
      "TPO 2",
      "TPO 3",
      "TPO 4",
      "TPO 5",
      "Factionalism",
      "Pop. Density",
      "Area (sq.mi.)",
      "2014 Cycle",
      "2016 Cycle" 
    ),
    prefix = case_when(
      str_detect(prefix, "Nuisance") ~ "Controls",
      TRUE ~ prefix
    ),
    stage = case_when(
      str_detect(term, "med") ~ 1,
      str_detect(term, "trt") ~ 2
    )
  ) %>%
  print() 
```

```{r party-coefs}
big_coefplot <- function(data, color = "black") {
  ggplot(data) +
  aes(x = fct_rev(term_label), y = estimate) +
  facet_wrap(~ prefix, nrow = 3, scales = "free") +
  geom_hline(yintercept = 0) +
  geom_pointrange(
    aes(ymin = conf.low, ymax = conf.high, shape = str_glue("Stage {stage}")),
    position = position_dodge(width = -.25),
    color = {{color}}, fill = "white"
  ) +
  scale_color_manual(values = party_factor_colors) +
  scale_shape_manual(values = c(22, 16)) +
  coord_flip() +
  labs(x = NULL, y = NULL)
}

d_coefs_left <- (
  {
    pretty_coefs %>%
    filter(party_num == 1) %>%
    filter(incumbency == "All", prim_rules == "All") %>%
    filter(prefix == "Causal Parameters") %>%
    big_coefplot(color = dblue) +
    labs(shape = NULL) +
    theme(legend.position = "none")
  } / {
    pretty_coefs %>%
    filter(party_num == 1) %>%
    filter(incumbency == "All", prim_rules == "All") %>%
    filter(prefix == "Scale Terms") %>%
    big_coefplot(color = dblue) +
    labs(y = "Posterior Parameter Value") +
    labs(shape = NULL) +
    theme(legend.position = "none")
  } 
)


d_coefs <- ( d_coefs_left | 
  pretty_coefs %>%
  filter(party_num == 1) %>% 
  filter(incumbency == "All", prim_rules == "All") %>% 
  filter(prefix == "Controls") %>% 
  big_coefplot(color = dblue) +
  labs(y = "Posterior Parameter Value", shape = NULL) +
  theme(
    legend.position = c(0.8, 0.8),
    legend.background = element_rect(color = "black", fill = "white")
  )
) + 
  plot_annotation(
    title = "Sequential G Parameters", 
    subtitle = "All Democratic Candidates"
  )



r_coefs_left <- (
  {
    pretty_coefs %>%
    filter(party_num == 2) %>%
    filter(incumbency == "All", prim_rules == "All") %>%
    filter(prefix == "Causal Parameters") %>%
    big_coefplot(color = rred) +
    labs(shape = NULL) +
    theme(legend.position = "none")
  } / {
    pretty_coefs %>%
    filter(party_num == 2) %>%
    filter(incumbency == "All", prim_rules == "All") %>%
    filter(prefix == "Scale Terms") %>%
    big_coefplot(color = rred) +
    labs(y = "Posterior Parameter Value") +
    labs(shape = NULL) +
    theme(legend.position = "none")
  } 
)


r_coefs <- ( r_coefs_left | 
  pretty_coefs %>%
  filter(party_num == 2) %>% 
  filter(incumbency == "All", prim_rules == "All") %>% 
  filter(prefix == "Controls") %>% 
  big_coefplot(color = rred) +
  labs(y = "Posterior Parameter Value", shape = NULL) +
  theme(
    legend.position = c(0.8, 0.8),
    legend.background = element_rect(color = "black", fill = "white")
  )
) + 
  plot_annotation(
    title = "Sequential G Parameters", 
    subtitle = "All Republican Candidates"
  )
```

```{r plot-d-coefs}
d_coefs
```

We now turn to the sequential $g$ results.
Figure \@ref(fig:plot-d-coefs) plots VB posterior means and 90% intervals for the full sample of Democratic candidates.
Stage 1 parameters are plotted as squares, and stage 2 parameters are plotted as circles.
The top-left panel contains the key parameters most relevant to causal inference, including the coefficients for the mediator and treatment variables from both stages of the estimation.
The bottom-left panel plots the standard deviations of the district errors and residual errors.
The right-side panel contains regression coefficients for all control variables.

```{r plot-d-coefs, include = TRUE, fig.height = 7.5, fig.width = 10, out.width = "100%", fig.scap = "Sequential $g$ results for Democratic candidates.", fig.cap = "Sequential $g$ results for Democratic candidates. Points and intervals are variational point estimates and 90 percent intervals from the approximate posterior distribution."}
```

Under sequential ignorabilitiy and no intermediate interactions assumptions, stage 1 estimates the effect of the past presidential vote share on CF scores. 
Interstingly, this coefficient is negative, indicating that Democratic primary candidates running in districts that vote more heavily Republican are actually more _progressive_ than Democratic candidates who represent more Democratic-leaning districts.
This is is an unexpected relationship given the general findings in the literature that candidates take more moderate stances in more moderate districts, which should manifest as a positive coefficient. 
It is important to keep in mind that this sample of data contains incumbent and non-incumbent candidates, as well as primary winners and losers.
Because most primary elections do not occur under highly competitive circumstances, the typical primary campaign may not resemble the predictions from "Downsian" formal models that assume perfect candidate competition [@burden:2004:candidate-positioning].
The mixture of incumbent and non-incumbent candidates may weight the sample more heavily toward candidates who corner more extreme or idiosyncratic candidate positions in their attempts to attract attention away from incumbents, who are likely to position themselves more in line with overall district preferences [@ansolabehere-et-al:2001:candidate-positioning].
The models that stratify on incumbency in Section \@ref(sec:g-modification) are consistent with these possibilities.
One other possibility is that the introduction of my new measure, district-party ideology, is responsible.
If candidates are indeed sensitive to _partisan_ preferences in their district, and partisan preferences are positively correlated with district voting on average, then the strong relationship between candidate positions and the district vote was at least partially confounded in all past studies. 
The results in Figure \@ref(fig:plot-d-coefs) are consistent with that possibility, since the coefficient on district-party ideology is large and positive even in stage 1, when it does not have a causal interpretation but is instead included as a control to identify the presidential vote effect.

The controlled direct effect of district-party ideology is positive, with a posterior mean indicating that one-unit increase in district-party ideology causing a 
`r std_coefs %>% filter(party_num == 1, incumbency == "All", prim_rules == "All") %>% pull(b) %>% round(2)`-unit increase in CFscores. 
Using standardized coefficients, the posterior mean suggests that an increase of one standard deviation in district-party ideology causes `r std_coefs %>% filter(party_num == 1, incumbency == "All", prim_rules == "All") %>% pull(beta) %>% round(2)`-standard deviation increase in CF scores, which is a substantively small effect.

The control coefficients do not have causal interpretation, and even interpreting them as partial correlations is problematic because of collider bias. 
Nonetheless readers might find some of the coefficient estimates intriguing or intuitive given the makeup of the Democratic Party coalition and the polarized environment of the 2010s. 
The opposing party ideal point mean has a clear negative coefficient, indicating that more conservative Republicans coincide on average with more progressive Democrats.
Progressivism among Democrats is greater in districts with greater density, less land area, and greater numbers of service sector employees.
The year fixed effects suggest candidates are more liberal in more recent years, which fits a pattern of polarization over time.
Some interesting or counter-intuitive findings are that Democrats are more progressive in districts with more college graduates and more blue-collar workers, and they are more conservative in districts with higher poverty.


```{r plot-r-coefs}
r_coefs
```

Turning to the Republican estimates in Figure \@ref(fig:plot-r-coefs), we find a similar pattern among the causal parameters.
The presidential vote is again inversely related to ideal points, with greater Republican voting causing more conservative Republican candidates under the causal assumptions.
We also find a positive controlled direct effect of district-party ideology in the stage 2 model, indicating that Republicans run more conservative campaigns in more conservative districts.
The district-party ideology effect in the Republican Party is larger than the effects in the Democratic Party on the scale of the raw data, with a coefficient of `r std_coefs %>% filter(party_num == 2, incumbency == "All", prim_rules == "All") %>% pull(b) %>% round(2)` (versus `r std_coefs %>% filter(party_num == 1, incumbency == "All", prim_rules == "All") %>% pull(b) %>% round(2)`). 
In standardized coefficients, the effects are more similar, with a Republican coefficient of `r std_coefs %>% filter(party_num == 2, incumbency == "All", prim_rules == "All") %>% pull(beta) %>% round(2)` versus the Democratic coefficient of `r std_coefs %>% filter(party_num == 1, incumbency == "All", prim_rules == "All") %>% pull(beta) %>% round(2)`.
This is because district-party ideology is more similar across Republican groups than Democratic groups, with a standard deviation in ideal point means of `r std_coefs %>% filter(party_num == 2, incumbency == "All", prim_rules == "All") %>% pull(sdx) %>% round(2)` versus `r std_coefs %>% filter(party_num == 1, incumbency == "All", prim_rules == "All") %>% pull(sdx) %>% round(2)`, meaning that one standardized unit increase is a smaller increase in absolute terms among Republicans than among Democrats.

```{r plot-r-coefs, include = TRUE, fig.height = 7.5, fig.width = 10, out.width = "100%", fig.scap = "Sequential $g$ results for Republican candidates.", fig.cap = "Sequential $g$ results for Republican candidates. Points and intervals are variational point estimates and 90 percent intervals from the approximate posterior distribution."}
```

Benchmarking these cross-party comparisons using raw or standardized coefficients has consequences for the conclusions we can draw about representation in the two parties.
One interpretation places greater emphasis on the standardized picture:
the initial appearance of greater responsiveness among Republicans using raw coefficients [e.g. @clinton:2006:constituent-representation] makes an incorrect assumption that the scope of ideological conflict is the same among Democrats and Republicans, when in fact Republican voters and elites are much more ideologically cohesive than Democrats [@lelkes-sniderman:2016:ideological-asymmetry]. 
But conditioning on the actual scope of ideological conflict in the two parties, Republican and Democratic candidates respond to their constituencies with proportional adjustments to their campaign positions.
Another interpretation places greater emphasis on the raw coefficients: if the scope of ideological conflict within the Democratic Party is greater, this is essential to keep in mind for understanding how candidates position themselves in relation to voters.
If the Democratic Party contains a larger variety of conflicting group interests, and elite party members have to reign these interests into a coherent platform, the result could be an elite party that appears to be insensitive to the big-tent heterogeneity in voters' policy preferences.



### Effect modification: incumbency status and primary rules {#sec:g-modification}

This section examines the results for models estimated within strata defined by candidate incumbency status and state primary rules.
It is an important to note that conditional effects do not necessarily represent the causal effects of stratum membership, a distinction that is often overlooked in examinations of heterogeneous causal effects [@kam-trussler:2017:HTEs].
Differences in the CDE across incumbency or primary rules reflect causal heterogeneity, but the sources of heterogeneity could come from factors that confound the the link between strata and outcomes.
As such, these results should be seen from an "effect modification" point of view.
In order to claim that incumbency or primary rules _cause_ heterogeneity in the effects of district-party ideology requires additional assumptions that incumbency or primary rules are ignorable, which are tasks large enough to fill separate dissertations altogether.

I first examine effects by stratifying across candidate status, estimating separate models for incumbents, challengers of incumbents, and open seat candidates.
<!------- TO DO ---------
- challenger of same-party incumbent, challenger of different-party incumbent
------------------------->
Prevailing literature that examines incumbency and candidate positioning have diverging predictions for these results.
@ansolabehere-et-al:2001:candidate-positioning find that incumbents take more moderate campaign positions than non-incumbent candidates, with challengers taking more extreme than both incumbents and open seat candidates.
This reflects a perspective that incumbency selects for candidates that take median positions that ensure their reelection, while challengers must take more innovative and extreme stances to garner attention.
@burden:2004:candidate-positioning finds instead that incumbents take more partisan positions, perhaps because incumbency provides other advantages that give incumbents more security to take positions that don't match district preferences as closely.

```{r plot-coef-incumbency}
incumbency_coef_tab <- pretty_coefs %>%
  filter(prim_rules == "All") %>%
  filter(incumbency != "All") %>%
  filter(term %in% c("coef_theta_trt", "coef_mediator"))

ggplot(incumbency_coef_tab) +
  aes(
    x = fct_rev(term_label), 
    y = estimate, 
    color = as.factor(party_num), 
    shape = as.factor(party_num)
  ) +
  facet_grid(. ~ fct_relevel(incumbency, "Incumbent")) +
  geom_hline(yintercept = 0) +
  geom_pointrange(
    aes(ymin = conf.low, ymax = conf.high),
    position = position_dodge(width = -0.25),
    fill = "white"
  ) +
  geom_mark_circle(
    data = 
      incumbency_coef_tab %>%
      filter(incumbency == "Incumbent") %>%
      filter(
        (term == "coef_theta_trt" & party_num == 1) | 
        (term == "coef_theta_trt" & party_num == 2)
      )
      ,
    aes(label = names(party_colors)[party_num]),
    position = position_dodge(width = -0.25),
    label.family = font_fam,
    label.fontface = "plain",
    label.fontsize = 8, 
    label.fill = "gray95", 
    label.buffer = unit(1, "mm"),
    con.type = "straight", con.cap = 0
  ) +
  scale_color_manual(values = party_factor_colors) +
  scale_shape_manual(values = c("1" = 16, "2" = 22)) +
  scale_x_discrete(
    labels = c("CDE: District-Party Ideology", "Presidential Vote (Stage 1)")
  ) +
  theme(
    legend.position = "none",
    plot.title.position = "plot"
  ) +
  coord_flip() +
  labs(
    y = "Posterior Parameter Value", x = NULL,
    title = "Effect Modification by Incumbency Status",
    subtitle = "Mediator Effects and Controlled Direct Effects"
  )
```

The findings in this study contain a mixture of evidence for against each of these views.
Figure \@ref(fig:plot-coef-incumbency) plots the mediator effect and controlled direct effect for incumbents, challengers, and open seat candidates.
Among Democrats, incumbents appear to follow patterns of positioning dictated by the SPD.
Coefficients for the presidential vote and district-party ideology are both positive, indicating that Democrats run as more progressive candidates in districts with higher Democratic presidential voting and with more progressive partisan constituents.
Challenger positioning is inversely related to the presidential vote but positively related to district-party ideology, indicating that challengers target the partisan constituency at the expense of the general election constituency.
This is consistent with an account of incumbent–challenger dynamics where challengers take extreme positions to garner attention to themselves against a more moderate, or that the responsiveness of incumbents results from the selection of well-fitting candidates by district voting [@ansolabehere-et-al:2001:candidate-positioning].
Open seat candidates behave more similarly to incumbents than to challengers, which contradicts the finding by @ansolabehere-et-al:2001:candidate-positioning that open seat candidates may be most "out of step" with district preferences, and may be more consistent with the @burden:2004:candidate-positioning argument that non-incumbents position themselves most aggressively to match voter preferences because they have fewer build-in advantages to overcome any ideological mis-fits.

```{r plot-coef-incumbency, include = TRUE, fig.width = 9, fig.height = 5, out.width = "100%", fig.scap = "Sequential $g$ results for incumbents, challengers, and open seat candidates.", fig.cap = "Sequential $g$ results for incumbents, challengers, and open seat candidates. Points and intervals are variational point estimates and 90 percent intervals from the approximate posterior distribution."}
```

Among Republicans, the results suggest that incumbent candidates are responsive to within-party preferences, but essentially unrelated to aggregate district voting.
This is consistent with a @clinton:2006:constituent-representation view that Republicans position themselves to fit their partisan constituencies, and correlation with district voting is incidental. 
This also fits with the Burden argument that incumbency provides insurance that lets incumbents deviate from district-optimal preferences, which is also consistent with the finding that Republican challengers are more responsive to district voting than Republican incumbents.
Results among Republican incumbents are difficult to interpret, since the results show a negative effect of Republican voting and no clear relationship between district-party conservatism and candidate conservatism.
Overall, these results suggest that nearly candidates of all incumbency status are responsive on average to district-party ideology, which supports an SPD view of primary competition.
Among incumbents, the greater degree of general-election responsiveness by Democrats than Republicans tracks @clinton:2006:constituent-representation, but the non-uniform findings among challengers and incumbents lack a clear interpretation.



```{r plot-coef-rules}
pretty_coefs %>%
  filter(incumbency == "All") %>%
  filter(prim_rules != "All") %>%
  filter(term == "coef_theta_trt") %>%
  ggplot() +
  aes(x = fct_relevel(prim_rules, "closed", "semi", "open") %>% fct_rev(), 
      y = estimate, color = as.factor(party_num)) +
  facet_grid(. ~ names(party_colors)[party_num]) +
  geom_hline(yintercept = 0) +
  geom_pointrange(
    aes(ymin = conf.low, ymax = conf.high),
    position = position_dodge(width = -0.25)
  ) +
  scale_color_manual(values = party_factor_colors) +
  scale_x_discrete(labels = c("Open", "Semi-Closed", "Closed")) +
  theme(
    legend.position = "none",
    plot.title.position = "plot"
  ) +
  coord_flip() +
  labs(
    y = "Controlled Direct Effect of\nDistrict-Party Ideology", 
    x = NULL,
    title = "Effect Modification by Primary Openness",
    subtitle = "Controlled Direct Effects of District-Party Ideology"
  )
```

We now turn to an examination of primary rules.
Past studies of primary rules typically find no clear effects of different rules either on candidate positioning or vote choice.
These studies never measure district-party ideology, however, so has never been clear whether candidates are in fact more responsive to district-party ideology in less-open primary systems.
My results in Figure \@ref(fig:plot-coef-rules) suggest that the inclusion of district-party preferences is consequential for understanding primary openness.
Among Democrats, the controlled direct effect of district party ideology is strongest in closed systems and weakest in open systems, with semi-closed systems in the middle.
This monotonic relationship is exactly consistent with the conventional wisdom on primary openness and candidate positioning.
The results among Republicans are not monotonic—the strongest relationship is among semi-closed rather than closed systems—but generally support a conclusion that candidates in open systems are less responsive to district-party ideology, where the relationship between district-parties and candidates is actually negative.

```{r plot-coef-rules, include = TRUE, fig.width = 8, fig.height = 4, out.width = "100%", fig.scap = "Sequential $g$ results for candidates in states with closed, semi-closed, and open primary systems.", fig.cap = "Sequential $g$ results for candidates in states with closed, semi-closed, and open primary systems. Points and intervals are variational point estimates and 90 percent intervals from the approximate posterior distribution."}
```
<!------- TO DO ---------
- you might say "this could be bullshit" 
  but that isn't exactly constructive
  and also it's obvious because of the selection design
------------------------->
It is worth reiterating that these patterns across primary rules should not be interpreted as causal, although it notable that they diverge from the majority of recent research on the effects of primary rules.
Furthermore, even though candidates may position themselves in accordance with the strategic environment created by primary institutions, this is no guarantee that primary voters recognize which candidate best fits their ideological preferences conditional on a slate of primary candidates.
This is a question I revisit in Chapter \@ref(ch:voting).



## Discussion

This study contained three notable contributions for the study of the strategic positioning dilemma and primary candidate positioning.
First, I employ novel measures of district-party ideology, a concept that is essential to the SPD theory but never operationalized in existing studies to date.
Second, I advance the causal credibility of these studies by positing a causal estimand and implementing a statistical approach that estimates it under explicitly stated assumptions.
And third, I demonstrate how to bring this method into a Bayesian causal framework, incorporating measurement error in the key independent variable as a prior distribution and deriving a posterior distribution that summarizes uncertainty in all model parameters.
I find that primary candidates do position themselves to fit district-party policy preferences, even when controlling for aggregate district voting as an intermediary causal mechanisms.
Furthermore, I find that candidate responsiveness is generally greater in states with stricter primary participation rules, a hypothesis that is common among political punditry but doubted among primary elections research.

The contributions of this study provide a structure for improving the research further.
Causal diagrams are valuable for understanding how theories of primaries other than the SPD could manifest in the data.
Consider, for instance, the notion that candidates position themselves to earn the good favor and resources of policy-demanding groups in the party network.
Whether this theoretical perspective jeopardize the causal interpretation of the preceding analysis depends on where policy-demanding are located in a causal diagram.
If intermediary groups are an outgrowth of the social, economic, and other demographic bases of the district—so they are descendants of variables $x_{d}$—and partisan voters take opinion cues from these groups' activities in the district, then failing to control for intermediary group influence may lead to bias in the estimated effects of district-party ideology.

This study could also be improved by collecting more years of data and setting up a different research design based on within-unit variation, such as a difference-in-differences panel design.
Unfortunately, most routine implementations of difference-in-differences modeling are problematic under data with variation in treatment timing, an issue that econometricians are only just starting to understand [@goodman-bacon:2018:DiD-timing].
Panel data approaches to causal inference in political science either generalize the "demediation" routine already employed in this analysis [@blackwell-glynn:2018:causal-TSCS] or use fixed-effects models that require particular assumptions how past treatments and outcomes are allowed to affect future treatments and future outcomes [@imai-kim:2019:fixed-effects-causal-inference].
Modernizing the primary representation literature for a new generation of causal approaches will not be a simple, one-off endeavor.

Even if researchers stick to the single-stage demediation approach, they could relax modeling assumptions by moving away from the linear modeling laid out by @acharya-blackwell-sen:2016:direct-effects and implemented in this chapter. 
Because the identification assumptions, demediation function, and ACDE are nonparametrically defined in terms of expectations about data, the method could be implemented using more flexible estimators of conditional expectations such as matching or machine learning methods.


